From 1367abe542921d4649fd4a1ef7eb15b7d994aee9 Mon Sep 17 00:00:00 2001
From: catfreed <catherine@kubos.co>
Date: Fri, 30 Sep 2016 15:43:25 -0500
Subject: [PATCH 01/37] Creating configuration for KubOS at91sam9g20-based
 board

---
 board/kubos/at91sam9g20kubos/Kconfig            |  12 ++
 board/kubos/at91sam9g20kubos/MAINTAINERS        |  17 ++
 board/kubos/at91sam9g20kubos/Makefile           |  14 ++
 board/kubos/at91sam9g20kubos/at91sam9g20kubos.c | 170 ++++++++++++++++
 board/kubos/at91sam9g20kubos/led.c              |  22 +++
 board/kubos/at91sam9g20kubos/partition.c        |  26 +++
 include/configs/at91sam9g20kubos.h              | 252 ++++++++++++++++++++++++
 7 files changed, 513 insertions(+)
 create mode 100644 board/kubos/at91sam9g20kubos/Kconfig
 create mode 100644 board/kubos/at91sam9g20kubos/MAINTAINERS
 create mode 100644 board/kubos/at91sam9g20kubos/Makefile
 create mode 100644 board/kubos/at91sam9g20kubos/at91sam9g20kubos.c
 create mode 100644 board/kubos/at91sam9g20kubos/led.c
 create mode 100644 board/kubos/at91sam9g20kubos/partition.c
 create mode 100644 include/configs/at91sam9g20kubos.h

diff --git a/board/kubos/at91sam9g20kubos/Kconfig b/board/kubos/at91sam9g20kubos/Kconfig
new file mode 100644
index 0000000..cd5bdd2
--- /dev/null
+++ b/board/kubos/at91sam9g20kubos/Kconfig
@@ -0,0 +1,12 @@
+if TARGET_AT91SAM92G20KUBOS
+
+config SYS_BOARD
+	default "at91sam9g20kubos"
+
+config SYS_VENDOR
+	default "kubos"
+
+config SYS_CONFIG_NAME
+	default "at91sam9g20kubos"
+
+endif
diff --git a/board/kubos/at91sam9g20kubos/MAINTAINERS b/board/kubos/at91sam9g20kubos/MAINTAINERS
new file mode 100644
index 0000000..aa7898e
--- /dev/null
+++ b/board/kubos/at91sam9g20kubos/MAINTAINERS
@@ -0,0 +1,17 @@
+AT91SAM9260EK BOARD
+M:	Stelian Pop <stelian@popies.net>
+S:	Maintained
+F:	board/atmel/at91sam9260ek/
+F:	include/configs/at91sam9260ek.h
+F:	configs/at91sam9260ek_dataflash_cs0_defconfig
+F:	configs/at91sam9260ek_dataflash_cs1_defconfig
+F:	configs/at91sam9260ek_nandflash_defconfig
+F:	configs/at91sam9g20ek_2mmc_nandflash_defconfig
+F:	configs/at91sam9g20ek_dataflash_cs0_defconfig
+F:	configs/at91sam9g20ek_dataflash_cs1_defconfig
+F:	configs/at91sam9g20ek_mmc_defconfig
+F:	configs/at91sam9g20ek_2mmc_defconfig
+F:	configs/at91sam9g20ek_nandflash_defconfig
+F:	configs/at91sam9xeek_dataflash_cs0_defconfig
+F:	configs/at91sam9xeek_dataflash_cs1_defconfig
+F:	configs/at91sam9xeek_nandflash_defconfig
diff --git a/board/kubos/at91sam9g20kubos/Makefile b/board/kubos/at91sam9g20kubos/Makefile
new file mode 100644
index 0000000..e9b7e9a
--- /dev/null
+++ b/board/kubos/at91sam9g20kubos/Makefile
@@ -0,0 +1,14 @@
+#
+# (C) Copyright 2003-2008
+# Wolfgang Denk, DENX Software Engineering, wd@denx.de.
+#
+# (C) Copyright 2008
+# Stelian Pop <stelian@popies.net>
+# Lead Tech Design <www.leadtechdesign.com>
+#
+# SPDX-License-Identifier:	GPL-2.0+
+#
+
+obj-y	+= at91sam9g20kubos.o
+obj-y	+= led.o
+obj-$(CONFIG_HAS_DATAFLASH) += partition.o
diff --git a/board/kubos/at91sam9g20kubos/at91sam9g20kubos.c b/board/kubos/at91sam9g20kubos/at91sam9g20kubos.c
new file mode 100644
index 0000000..22396b0
--- /dev/null
+++ b/board/kubos/at91sam9g20kubos/at91sam9g20kubos.c
@@ -0,0 +1,170 @@
+/*
+ * (C) Copyright 2007-2008
+ * Stelian Pop <stelian@popies.net>
+ * Lead Tech Design <www.leadtechdesign.com>
+ *
+ * SPDX-License-Identifier:	GPL-2.0+
+ */
+
+#include <common.h>
+#include <asm/io.h>
+#include <asm/arch/at91sam9g20_matrix.h>
+#include <asm/arch/at91sam9_smc.h>
+#include <asm/arch/at91_common.h>
+#include <asm/arch/clk.h>
+#include <asm/arch/gpio.h>
+#include <atmel_mci.h>
+
+#if defined(CONFIG_RESET_PHY_R) && defined(CONFIG_MACB)
+# include <net.h>
+#endif
+#include <netdev.h>
+
+DECLARE_GLOBAL_DATA_PTR;
+
+/* ------------------------------------------------------------------------- */
+/*
+ * Miscelaneous platform dependent initialisations
+ */
+
+#ifdef CONFIG_CMD_NAND
+static void at91sam9g20kubos_nand_hw_init(void)
+{
+	struct at91_smc *smc = (struct at91_smc *)ATMEL_BASE_SMC;
+	struct at91_matrix *matrix = (struct at91_matrix *)ATMEL_BASE_MATRIX;
+	unsigned long csa;
+
+	/* Assign CS3 to NAND/SmartMedia Interface */
+	csa = readl(&matrix->ebicsa);
+	csa |= AT91_MATRIX_CS3A_SMC_SMARTMEDIA;
+	writel(csa, &matrix->ebicsa);
+
+	/* Configure SMC CS3 for NAND/SmartMedia */
+	writel(AT91_SMC_SETUP_NWE(1) | AT91_SMC_SETUP_NCS_WR(0) |
+		AT91_SMC_SETUP_NRD(1) | AT91_SMC_SETUP_NCS_RD(0),
+		&smc->cs[3].setup);
+	writel(AT91_SMC_PULSE_NWE(3) | AT91_SMC_PULSE_NCS_WR(3) |
+		AT91_SMC_PULSE_NRD(3) | AT91_SMC_PULSE_NCS_RD(3),
+		&smc->cs[3].pulse);
+	writel(AT91_SMC_CYCLE_NWE(5) | AT91_SMC_CYCLE_NRD(5),
+		&smc->cs[3].cycle);
+	writel(AT91_SMC_MODE_RM_NRD | AT91_SMC_MODE_WM_NWE |
+		AT91_SMC_MODE_EXNW_DISABLE |
+#ifdef CONFIG_SYS_NAND_DBW_16
+		AT91_SMC_MODE_DBW_16 |
+#else /* CONFIG_SYS_NAND_DBW_8 */
+		AT91_SMC_MODE_DBW_8 |
+#endif
+		AT91_SMC_MODE_TDF_CYCLE(2),
+		&smc->cs[3].mode);
+
+	/* Configure RDY/BSY */
+	at91_set_gpio_input(CONFIG_SYS_NAND_READY_PIN, 1);
+
+	/* Enable NandFlash */
+	at91_set_gpio_output(CONFIG_SYS_NAND_ENABLE_PIN, 1);
+
+}
+#endif
+
+#ifdef CONFIG_MACB
+static void at91sam9g20kubos_macb_hw_init(void)
+{
+	struct at91_port *pioa = (struct at91_port *)ATMEL_BASE_PIOA;
+
+	at91_periph_clk_enable(ATMEL_ID_EMAC0);
+
+	/*
+	 * Disable pull-up on:
+	 *	RXDV (PA17) => PHY normal mode (not Test mode)
+	 *	ERX0 (PA14) => PHY ADDR0
+	 *	ERX1 (PA15) => PHY ADDR1
+	 *	ERX2 (PA25) => PHY ADDR2
+	 *	ERX3 (PA26) => PHY ADDR3
+	 *	ECRS (PA28) => PHY ADDR4  => PHYADDR = 0x0
+	 *
+	 * PHY has internal pull-down
+	 */
+	writel(pin_to_mask(AT91_PIN_PA14) |
+		pin_to_mask(AT91_PIN_PA15) |
+		pin_to_mask(AT91_PIN_PA17) |
+		pin_to_mask(AT91_PIN_PA25) |
+		pin_to_mask(AT91_PIN_PA26) |
+		pin_to_mask(AT91_PIN_PA28),
+		&pioa->pudr);
+
+	at91_phy_reset();
+
+	/* Re-enable pull-up */
+	writel(pin_to_mask(AT91_PIN_PA14) |
+		pin_to_mask(AT91_PIN_PA15) |
+		pin_to_mask(AT91_PIN_PA17) |
+		pin_to_mask(AT91_PIN_PA25) |
+		pin_to_mask(AT91_PIN_PA26) |
+		pin_to_mask(AT91_PIN_PA28),
+		&pioa->puer);
+
+	/* Initialize EMAC=MACB hardware */
+	at91_macb_hw_init();
+}
+#endif
+
+#ifdef CONFIG_GENERIC_ATMEL_MCI
+int board_mmc_init(bd_t *bd)
+{
+	at91_mci_hw_init();
+
+	return atmel_mci_init((void *)ATMEL_BASE_MCI);
+}
+#endif
+
+int board_early_init_f(void)
+{
+	at91_periph_clk_enable(ATMEL_ID_PIOA);
+	at91_periph_clk_enable(ATMEL_ID_PIOB);
+	at91_periph_clk_enable(ATMEL_ID_PIOC);
+
+	return 0;
+}
+
+int board_init(void)
+{
+	/* adress of boot parameters */
+	gd->bd->bi_boot_params = CONFIG_SYS_SDRAM_BASE + 0x100;
+
+	at91_seriald_hw_init();
+#ifdef CONFIG_CMD_NAND
+	at91sam9g20kubos_nand_hw_init();
+#endif
+#ifdef CONFIG_HAS_DATAFLASH
+	at91_spi0_hw_init((1 << 0) | (1 << 1));
+#endif
+#ifdef CONFIG_MACB
+	at91sam9g20kubos_macb_hw_init();
+#endif
+
+	return 0;
+}
+
+int dram_init(void)
+{
+	gd->ram_size = get_ram_size(
+		(void *)CONFIG_SYS_SDRAM_BASE,
+		CONFIG_SYS_SDRAM_SIZE);
+	return 0;
+}
+
+#ifdef CONFIG_RESET_PHY_R
+void reset_phy(void)
+{
+}
+#endif
+
+int board_eth_init(bd_t *bis)
+{
+	int rc = 0;
+#ifdef CONFIG_MACB
+	rc = macb_eth_initialize(0, (void *)ATMEL_BASE_EMAC0, 0x00);
+#endif
+	return rc;
+}
diff --git a/board/kubos/at91sam9g20kubos/led.c b/board/kubos/at91sam9g20kubos/led.c
new file mode 100644
index 0000000..fbe15af
--- /dev/null
+++ b/board/kubos/at91sam9g20kubos/led.c
@@ -0,0 +1,22 @@
+/*
+ * (C) Copyright 2007-2008
+ * Stelian Pop <stelian@popies.net>
+ * Lead Tech Design <www.leadtechdesign.com>
+ *
+ * SPDX-License-Identifier:	GPL-2.0+
+ */
+
+#include <common.h>
+#include <asm/io.h>
+#include <asm/arch/gpio.h>
+#include <status_led.h>
+
+void coloured_LED_init(void)
+{
+	/* Clock is enabled in board_early_init_f() */
+	at91_set_gpio_output(CONFIG_RED_LED, 1);
+	at91_set_gpio_output(CONFIG_GREEN_LED, 1);
+
+	at91_set_gpio_value(CONFIG_RED_LED, 0);
+	at91_set_gpio_value(CONFIG_GREEN_LED, 1);
+}
diff --git a/board/kubos/at91sam9g20kubos/partition.c b/board/kubos/at91sam9g20kubos/partition.c
new file mode 100644
index 0000000..e41eefe
--- /dev/null
+++ b/board/kubos/at91sam9g20kubos/partition.c
@@ -0,0 +1,26 @@
+/*
+ * (C) Copyright 2008
+ * Ulf Samuelsson <ulf@atmel.com>
+ *
+ * SPDX-License-Identifier:	GPL-2.0+
+ */
+#include <common.h>
+#include <config.h>
+#include <asm/hardware.h>
+#include <dataflash.h>
+
+AT91S_DATAFLASH_INFO dataflash_info[CONFIG_SYS_MAX_DATAFLASH_BANKS];
+
+struct dataflash_addr cs[CONFIG_SYS_MAX_DATAFLASH_BANKS] = {
+	{CONFIG_SYS_DATAFLASH_LOGIC_ADDR_CS0, 0},	/* Logical adress, CS */
+	{CONFIG_SYS_DATAFLASH_LOGIC_ADDR_CS1, 1}
+};
+
+/*define the area offsets*/
+dataflash_protect_t area_list[NB_DATAFLASH_AREA] = {
+	{0x00000000, 0x000041FF, FLAG_PROTECT_SET,   0, "Bootstrap"},
+	{0x00004200, 0x000083FF, FLAG_PROTECT_CLEAR, 0, "Environment"},
+	{0x00008400, 0x00083FFF, FLAG_PROTECT_SET,   0, "U-Boot"},
+	{0x00084000, 0x00293FFF, FLAG_PROTECT_CLEAR, 0,	"Kernel"},
+	{0x00294000, 0xFFFFFFFF, FLAG_PROTECT_CLEAR, 0,	"FS"},
+};
diff --git a/include/configs/at91sam9g20kubos.h b/include/configs/at91sam9g20kubos.h
new file mode 100644
index 0000000..1c244c3
--- /dev/null
+++ b/include/configs/at91sam9g20kubos.h
@@ -0,0 +1,252 @@
+/*
+ * (C) Copyright 2007-2008
+ * Stelian Pop <stelian@popies.net>
+ * Lead Tech Design <www.leadtechdesign.com>
+ *
+ * Configuation settings for the AT91SAM9260EK & AT91SAM9G20EK boards.
+ *
+ * SPDX-License-Identifier:	GPL-2.0+
+ */
+
+#ifndef __CONFIG_H
+#define __CONFIG_H
+
+/*
+ * SoC must be defined first, before hardware.h is included.
+ * In this case SoC is defined in boards.cfg.
+ */
+#include <asm/hardware.h>
+
+/*
+ * Warning: changing CONFIG_SYS_TEXT_BASE requires
+ * adapting the initial boot program.
+ * Since the linker has to swallow that define, we must use a pure
+ * hex number here!
+ */
+#define CONFIG_SYS_TEXT_BASE		0x21f00000
+
+/* ARM asynchronous clock */
+#define CONFIG_SYS_AT91_SLOW_CLOCK	32768		/* slow clock xtal */
+#define CONFIG_SYS_AT91_MAIN_CLOCK	18432000	/* main clock xtal */
+
+/* Define actual evaluation board type from used processor type */
+#ifdef CONFIG_AT91SAM9G20
+# define CONFIG_AT91SAM9G20KUBOS	/* It's an Atmel AT91SAM9G20 EK */
+#else
+#error Messed up board configuration!
+# define CONFIG_AT91SAM9260EK	/* It's an Atmel AT91SAM9260 EK */
+#endif
+
+/* Misc CPU related */
+#define CONFIG_ARCH_CPU_INIT
+#define CONFIG_CMDLINE_TAG		/* enable passing of ATAGs */
+#define CONFIG_SETUP_MEMORY_TAGS
+#define CONFIG_INITRD_TAG
+#define CONFIG_SKIP_LOWLEVEL_INIT
+#define CONFIG_BOARD_EARLY_INIT_F
+#define CONFIG_DISPLAY_CPUINFO
+
+/* general purpose I/O */
+#define CONFIG_ATMEL_LEGACY		/* required until (g)pio is fixed */
+#define CONFIG_AT91_GPIO
+#define CONFIG_AT91_GPIO_PULLUP	1	/* keep pullups on peripheral pins */
+
+/* serial console */
+#define CONFIG_ATMEL_USART
+#define CONFIG_USART_BASE		ATMEL_BASE_DBGU
+#define	CONFIG_USART_ID			ATMEL_ID_SYS
+#define CONFIG_BAUDRATE			115200
+
+/* LED */
+#define CONFIG_AT91_LED
+#define	CONFIG_RED_LED		AT91_PIN_PA9	/* this is the power led */
+#define	CONFIG_GREEN_LED	AT91_PIN_PA6	/* this is the user led */
+
+
+/*
+ * BOOTP options
+ */
+#define CONFIG_BOOTP_BOOTFILESIZE	1
+#define CONFIG_BOOTP_BOOTPATH		1
+#define CONFIG_BOOTP_GATEWAY		1
+#define CONFIG_BOOTP_HOSTNAME		1
+
+/*
+ * Command line configuration.
+ */
+#define CONFIG_CMD_NOR		1
+
+/*
+ * SDRAM: 1 bank, min 32, max 128 MB
+ * Initialized before u-boot gets started.
+ */
+#define CONFIG_NR_DRAM_BANKS		1
+#define CONFIG_SYS_SDRAM_BASE		ATMEL_BASE_CS1
+#define CONFIG_SYS_SDRAM_SIZE		0x02000000         //32MB
+
+/*
+ * Initial stack pointer: 4k - GENERATED_GBL_DATA_SIZE in internal SRAM,
+ * leaving the correct space for initial global data structure above
+ * that address while providing maximum stack area below.
+ */
+#ifdef CONFIG_AT91SAM9XE
+# define CONFIG_SYS_INIT_SP_ADDR \
+	(ATMEL_BASE_SRAM + 0x1000 - GENERATED_GBL_DATA_SIZE)
+#else
+# define CONFIG_SYS_INIT_SP_ADDR \
+	(ATMEL_BASE_SRAM1 + 0x1000 - GENERATED_GBL_DATA_SIZE)
+#endif
+
+/*
+ * The (arm)linux board id set by generic code depending on configured board
+ * (see boards.cfg for different boards)
+ */
+#ifdef CONFIG_AT91SAM9G20
+	/* the sam9g20 variants have two different board ids */
+# ifdef CONFIG_AT91SAM9G20KUBOS
+	/* we may be setup for the 2MMC variant of at91sam9g20ek */
+#  define CONFIG_MACH_TYPE MACH_TYPE_AT91SAM9G20KUBOS
+# else
+	/* or the normal at91sam9g20ek */
+#  define CONFIG_MACH_TYPE MACH_TYPE_AT91SAM9G20EK
+# endif
+#else
+	/* otherwise default to good old at91sam9260ek */
+# define CONFIG_MACH_TYPE MACH_TYPE_AT91SAM9260EK
+#endif
+
+#ifndef CONFIG_AT91SAM9G20KUBOS
+/* DataFlash */
+#define CONFIG_ATMEL_DATAFLASH_SPI
+#define CONFIG_HAS_DATAFLASH		1
+#define CONFIG_SYS_MAX_DATAFLASH_BANKS		2
+#define CONFIG_SYS_DATAFLASH_LOGIC_ADDR_CS0	0xC0000000	/* CS0 */
+#define CONFIG_SYS_DATAFLASH_LOGIC_ADDR_CS1	0xD0000000	/* CS1 */
+#define AT91_SPI_CLK			15000000
+#else
+/* Enable MMC. The MCCK is conflicted with DataFlash */
+#endif
+
+#ifdef CONFIG_AT91SAM9G20KUBOS
+#define DATAFLASH_TCSS			(0x22 << 16)
+#else
+#define DATAFLASH_TCSS			(0x1a << 16)
+#endif
+#define DATAFLASH_TCHS			(0x1 << 24)
+
+/* NOR flash - Just changed 'NAND' to 'NOR'
+ * TODO: Check ALL of these values... */
+#ifdef CONFIG_CMD_NOR
+#define CONFIG_NOR_ATMEL
+#define CONFIG_SYS_MAX_NOR_DEVICE	1
+#define CONFIG_SYS_NOR_BASE		ATMEL_BASE_CS3
+#define CONFIG_SYS__DBW_8
+#define CONFIG_SYS__MASK_ALE	(1 << 21)
+#define CONFIG_SYS__MASK_CLE	(1 << 22)
+#define CONFIG_SYS__ENABLE_PIN	AT91_PIN_PC14
+#define CONFIG_SYS__READY_PIN	AT91_PIN_PC13
+#endif
+
+/* MMC */
+//TODO: Turn this on?  I think it's SD card support
+#ifdef CONFIG_CMD_MMC
+#define CONFIG_MMC
+#define CONFIG_GENERIC_MMC
+#define CONFIG_GENERIC_ATMEL_MCI
+#endif
+
+/* FAT */
+#ifdef CONFIG_CMD_FAT
+#define CONFIG_DOS_PARTITION
+#endif
+
+/* NOR flash - no real flash on this board */
+#define CONFIG_SYS_NO_FLASH			1
+
+/* USB */
+#define CONFIG_USB_ATMEL
+#define CONFIG_USB_ATMEL_CLK_SEL_PLLB
+#define CONFIG_USB_OHCI_NEW		1
+#define CONFIG_SYS_USB_OHCI_CPU_INIT		1
+#define CONFIG_SYS_USB_OHCI_REGS_BASE		0x00500000	/* AT91SAM9G20_UHP_BASE */
+#define CONFIG_SYS_USB_OHCI_SLOT_NAME		"at91sam9g20"
+#define CONFIG_SYS_USB_OHCI_MAX_ROOT_PORTS	2
+
+#define CONFIG_SYS_LOAD_ADDR			0x22000000	/* load address */
+
+#define CONFIG_SYS_MEMTEST_START		CONFIG_SYS_SDRAM_BASE
+#define CONFIG_SYS_MEMTEST_END			0x23e00000
+
+#ifdef CONFIG_SYS_USE_DATAFLASH_CS0
+
+/* bootstrap + u-boot + env + linux in dataflash on CS0 */
+#define CONFIG_ENV_IS_IN_DATAFLASH	1
+#define CONFIG_SYS_MONITOR_BASE	(CONFIG_SYS_DATAFLASH_LOGIC_ADDR_CS0 + 0x8400)
+#define CONFIG_ENV_OFFSET		0x4200
+#define CONFIG_ENV_ADDR		(CONFIG_SYS_DATAFLASH_LOGIC_ADDR_CS0 + CONFIG_ENV_OFFSET)
+#define CONFIG_ENV_SIZE		0x4200
+#define CONFIG_BOOTCOMMAND	"cp.b 0xC0084000 0x22000000 0x210000; bootm"
+#define CONFIG_BOOTARGS		"console=ttyS0,115200 "			\
+				"root=/dev/mtdblock0 "			\
+				"mtdparts=atmel_:-(root) "		\
+				"rw rootfstype=jffs2"
+
+#elif CONFIG_SYS_USE_DATAFLASH_CS1
+
+/* bootstrap + u-boot + env + linux in dataflash on CS1 */
+#define CONFIG_ENV_IS_IN_DATAFLASH	1
+#define CONFIG_SYS_MONITOR_BASE	(CONFIG_SYS_DATAFLASH_LOGIC_ADDR_CS1 + 0x8400)
+#define CONFIG_ENV_OFFSET		0x4200
+#define CONFIG_ENV_ADDR		(CONFIG_SYS_DATAFLASH_LOGIC_ADDR_CS1 + CONFIG_ENV_OFFSET)
+#define CONFIG_ENV_SIZE		0x4200
+#define CONFIG_BOOTCOMMAND	"cp.b 0xD0084000 0x22000000 0x210000; bootm"
+#define CONFIG_BOOTARGS		"console=ttyS0,115200 "			\
+				"root=/dev/mtdblock0 "			\
+				"mtdparts=atmel_:-(root) "		\
+				"rw rootfstype=jffs2"
+
+#elif defined(CONFIG_SYS_USE_FLASH)
+
+/* bootstrap + u-boot + env + linux in flash */
+#define CONFIG_ENV_IS_IN_	1
+#define CONFIG_ENV_OFFSET		0xc0000
+#define CONFIG_ENV_OFFSET_REDUND	0x100000
+#define CONFIG_ENV_SIZE		0x20000		/* 1 sector = 128 kB */
+#define CONFIG_BOOTCOMMAND	"NOR read 0x22000000 0x200000 0x300000; bootm"
+#define CONFIG_BOOTARGS							\
+	"console=ttyS0,115200 earlyprintk "				\
+	"mtdparts=atmel_:256k(bootstrap)ro,512k(uboot)ro,"		\
+	"256k(env),256k(env_redundant),256k(spare),"			\
+	"512k(dtb),6M(kernel)ro,-(rootfs) "				\
+	"root=/dev/mtdblock7 rw rootfstype=jffs2"
+
+#else	/* CONFIG_SYS_USE_MMC */
+/* bootstrap + u-boot + env + linux in mmc */
+#define CONFIG_ENV_IS_IN_MMC
+/* For FAT system, most cases it should be in the reserved sector */
+#define CONFIG_ENV_OFFSET		0x2000
+#define CONFIG_ENV_SIZE			0x1000
+#define CONFIG_SYS_MMC_ENV_DEV		0
+
+#define CONFIG_BOOTCOMMAND						\
+	"fatload mmc 0:1 0x22000000 uImage; bootm"
+#define CONFIG_BOOTARGS							\
+	"console=ttyS0,115200 earlyprintk "				\
+	"mtdparts=atmel_:256k(bootstrap)ro,512k(uboot)ro,"		\
+	"256k(env),256k(env_redundant),256k(spare),"			\
+	"512k(dtb),6M(kernel)ro,-(rootfs) "				\
+	"root=/dev/mmcblk0p2 rw rootfstype=ext4 rootwait"
+#endif
+
+#define CONFIG_SYS_CBSIZE		256
+#define CONFIG_SYS_MAXARGS		16
+#define CONFIG_SYS_LONGHELP		1
+#define CONFIG_CMDLINE_EDITING	1
+#define CONFIG_AUTO_COMPLETE
+
+/*
+ * Size of malloc() pool
+ */
+#define CONFIG_SYS_MALLOC_LEN		ROUND(3 * CONFIG_ENV_SIZE + 128*1024, 0x1000)
+
+#endif
-- 
2.7.4


From 2b6078850551d96c68120f779cbc6fc8c9e634ee Mon Sep 17 00:00:00 2001
From: catfreed <catherine@kubos.co>
Date: Fri, 30 Sep 2016 15:52:20 -0500
Subject: [PATCH 02/37] Minor fix to conform to standards

---
 include/configs/at91sam9g20kubos.h | 6 +++---
 1 file changed, 3 insertions(+), 3 deletions(-)

diff --git a/include/configs/at91sam9g20kubos.h b/include/configs/at91sam9g20kubos.h
index 1c244c3..b780720 100644
--- a/include/configs/at91sam9g20kubos.h
+++ b/include/configs/at91sam9g20kubos.h
@@ -77,12 +77,12 @@
 #define CONFIG_CMD_NOR		1
 
 /*
- * SDRAM: 1 bank, min 32, max 128 MB
+ * SDRAM: 1 bank, 32MB
  * Initialized before u-boot gets started.
  */
 #define CONFIG_NR_DRAM_BANKS		1
 #define CONFIG_SYS_SDRAM_BASE		ATMEL_BASE_CS1
-#define CONFIG_SYS_SDRAM_SIZE		0x02000000         //32MB
+#define CONFIG_SYS_SDRAM_SIZE		0x02000000
 
 /*
  * Initial stack pointer: 4k - GENERATED_GBL_DATA_SIZE in internal SRAM,
@@ -148,7 +148,7 @@
 #endif
 
 /* MMC */
-//TODO: Turn this on?  I think it's SD card support
+/* TODO: Turn this on?  I think it's SD card support */
 #ifdef CONFIG_CMD_MMC
 #define CONFIG_MMC
 #define CONFIG_GENERIC_MMC
-- 
2.7.4


From e8e211d9b1b1a0930c8e76a218f7b53a8f6c290c Mon Sep 17 00:00:00 2001
From: catfreed <catherine@kubos.co>
Date: Mon, 3 Oct 2016 13:23:05 -0500
Subject: [PATCH 03/37] More changes

---
 arch/arm/include/asm/mach-types.h  | 13 +++++++++++++
 include/configs/at91sam9g20kubos.h | 32 +++++++++++++++++++++++++++-----
 2 files changed, 40 insertions(+), 5 deletions(-)

diff --git a/arch/arm/include/asm/mach-types.h b/arch/arm/include/asm/mach-types.h
index d51be0b..3fde852 100644
--- a/arch/arm/include/asm/mach-types.h
+++ b/arch/arm/include/asm/mach-types.h
@@ -265,6 +265,7 @@ extern unsigned int __machine_arch_type;
 #define MACH_TYPE_TS409                1601
 #define MACH_TYPE_CM_X300              1616
 #define MACH_TYPE_AT91SAM9G20EK        1624
+#define MACH_TYPE_AT91SAM9G20KUBOS     1625
 #define MACH_TYPE_SMDK6410             1626
 #define MACH_TYPE_U300                 1627
 #define MACH_TYPE_WRT350N_V2           1633
@@ -4144,6 +4145,18 @@ extern unsigned int __machine_arch_type;
 # define machine_is_at91sam9g20ek()	(0)
 #endif
 
+#ifdef CONFIG_MACH_AT91SAM9G20KUBOS
+# ifdef machine_arch_type
+#  undef machine_arch_type
+#  define machine_arch_type	__machine_arch_type
+# else
+#  define machine_arch_type	MACH_TYPE_AT91SAM9G20KUBOS
+# endif
+# define machine_is_at91sam9g20kubos()	(machine_arch_type == MACH_TYPE_AT91SAM9G20KUBOS)
+#else
+# define machine_is_at91sam9g20kubos()	(0)
+#endif
+
 #ifdef CONFIG_MACH_SMDK6410
 # ifdef machine_arch_type
 #  undef machine_arch_type
diff --git a/include/configs/at91sam9g20kubos.h b/include/configs/at91sam9g20kubos.h
index b780720..63a91bf 100644
--- a/include/configs/at91sam9g20kubos.h
+++ b/include/configs/at91sam9g20kubos.h
@@ -205,21 +205,43 @@
 				"mtdparts=atmel_:-(root) "		\
 				"rw rootfstype=jffs2"
 
-#elif defined(CONFIG_SYS_USE_FLASH)
+#elif defined(CONFIG_SYS_USE_NORFLASH)
 
 /* bootstrap + u-boot + env + linux in flash */
-#define CONFIG_ENV_IS_IN_	1
+/* TODO: This configuration could use some work...*/
+#define CONFIG_ENV_IS_IN_FLASH	1
 #define CONFIG_ENV_OFFSET		0xc0000
-#define CONFIG_ENV_OFFSET_REDUND	0x100000
 #define CONFIG_ENV_SIZE		0x20000		/* 1 sector = 128 kB */
-#define CONFIG_BOOTCOMMAND	"NOR read 0x22000000 0x200000 0x300000; bootm"
+#define CONFIG_BOOTCOMMAND	"cp.b 0x22000000 0x200000 0x300000; bootm"
 #define CONFIG_BOOTARGS							\
 	"console=ttyS0,115200 earlyprintk "				\
 	"mtdparts=atmel_:256k(bootstrap)ro,512k(uboot)ro,"		\
-	"256k(env),256k(env_redundant),256k(spare),"			\
+	"256k(env),256k(spare),"			\
 	"512k(dtb),6M(kernel)ro,-(rootfs) "				\
 	"root=/dev/mtdblock7 rw rootfstype=jffs2"
 
+#define CONFIG_SYS_FLASH_CFI			1
+#define CONFIG_FLASH_CFI_DRIVER			1
+#define PHYS_FLASH_1				0x10000000
+#define CONFIG_SYS_FLASH_BASE			PHYS_FLASH_1
+#define CONFIG_SYS_MAX_FLASH_SECT		256
+#define CONFIG_SYS_MAX_FLASH_BANKS		1
+
+#define CONFIG_SYS_MONITOR_SEC	1:0-3
+#define CONFIG_SYS_MONITOR_BASE	CONFIG_SYS_FLASH_BASE
+#define CONFIG_SYS_MONITOR_LEN	(256 << 10)
+#define CONFIG_ENV_IS_IN_FLASH	1
+#define CONFIG_ENV_ADDR		(CONFIG_SYS_FLASH_BASE + 0x007E0000)
+/*#define CONFIG_ENV_ADDR_REDUND	(CONFIG_ENV_ADDR - CONFIG_ENV_SIZE)*/
+
+#define CONFIG_EXTRA_ENV_SETTINGS	\
+	"monitor_base=" __stringify(CONFIG_SYS_MONITOR_BASE) "\0" \
+	"update=" \
+		"protect off ${monitor_base} +${filesize};" \
+		"erase ${monitor_base} +${filesize};" \
+		"cp.b ${fileaddr} ${monitor_base} ${filesize};" \
+		"protect on ${monitor_base} +${filesize}\0"
+
 #else	/* CONFIG_SYS_USE_MMC */
 /* bootstrap + u-boot + env + linux in mmc */
 #define CONFIG_ENV_IS_IN_MMC
-- 
2.7.4


From 014e3420ecbd62e89aaa2e779df9cd39d6729ec0 Mon Sep 17 00:00:00 2001
From: catfreed <catherine@kubos.co>
Date: Mon, 3 Oct 2016 14:31:22 -0500
Subject: [PATCH 04/37] Updating Kconfig to add kubos board

---
 arch/arm/mach-at91/Kconfig   | 5 +++++
 1 files changed, 5 insertions(+)

diff --git a/arch/arm/mach-at91/Kconfig b/arch/arm/mach-at91/Kconfig
index 13e19ba..e3f5f74 100644
--- a/arch/arm/mach-at91/Kconfig
+++ b/arch/arm/mach-at91/Kconfig
@@ -30,6 +30,10 @@ config TARGET_GURNARD
 	select DM_SERIAL
 	select DM_GPIO
 	select DM_ETH
+	
+config TARGET_AT91SAM9G20KUBOS
+	bool "Kubos at91sam9g20 reference board"
+	select CPU_ARM926EJS
 
 config TARGET_AT91SAM9261EK
 	bool "Atmel at91sam9261 reference board"
@@ -175,6 +179,7 @@ source "board/calao/usb_a9263/Kconfig"
 source "board/denx/ma5d4evk/Kconfig"
 source "board/egnite/ethernut5/Kconfig"
 source "board/esd/meesc/Kconfig"
+source "board/kubos/at91sam9g20kubos/Kconfig"
 source "board/l+g/vinco/Kconfig"
 source "board/mini-box/picosam9g45/Kconfig"
 source "board/ronetix/pm9261/Kconfig"
-- 
2.7.4


From ff3f25000b8f3482db10303cc13ade8216846e9c Mon Sep 17 00:00:00 2001
From: catfreed <catherine@kubos.co>
Date: Mon, 3 Oct 2016 15:29:34 -0500
Subject: [PATCH 05/37] Fixing typo, fixing *_matrix.h, undoing whitelist

---
 board/kubos/at91sam9g20kubos/Kconfig            | 2 +-
 board/kubos/at91sam9g20kubos/at91sam9g20kubos.c | 2 +-
 2 files changed, 2 insertions(+), 2 deletions(-)

diff --git a/board/kubos/at91sam9g20kubos/Kconfig b/board/kubos/at91sam9g20kubos/Kconfig
index cd5bdd2..738d22c 100644
--- a/board/kubos/at91sam9g20kubos/Kconfig
+++ b/board/kubos/at91sam9g20kubos/Kconfig
@@ -1,4 +1,4 @@
-if TARGET_AT91SAM92G20KUBOS
+if TARGET_AT91SAM9G20KUBOS
 
 config SYS_BOARD
 	default "at91sam9g20kubos"
diff --git a/board/kubos/at91sam9g20kubos/at91sam9g20kubos.c b/board/kubos/at91sam9g20kubos/at91sam9g20kubos.c
index 22396b0..a9b95e4 100644
--- a/board/kubos/at91sam9g20kubos/at91sam9g20kubos.c
+++ b/board/kubos/at91sam9g20kubos/at91sam9g20kubos.c
@@ -8,7 +8,7 @@
 
 #include <common.h>
 #include <asm/io.h>
-#include <asm/arch/at91sam9g20_matrix.h>
+#include <asm/arch/at91sam9_matrix.h>
 #include <asm/arch/at91sam9_smc.h>
 #include <asm/arch/at91_common.h>
 #include <asm/arch/clk.h>
-- 
2.7.4


From a76c40f8f4a6638897f2c985bfa48ceecee4ac7c Mon Sep 17 00:00:00 2001
From: catfreed <catherine@kubos.co>
Date: Tue, 11 Oct 2016 14:19:10 -0500
Subject: [PATCH 06/37] Fixing config (hopefully), adding defconfig

---
 configs/at91sam9g20kubos_2mmc_norflash_defconfig | 21 +++++++++++
 include/configs/at91sam9g20kubos.h               | 45 +++++++++---------------
 2 files changed, 37 insertions(+), 29 deletions(-)
 create mode 100644 configs/at91sam9g20kubos_2mmc_norflash_defconfig

diff --git a/configs/at91sam9g20kubos_2mmc_norflash_defconfig b/configs/at91sam9g20kubos_2mmc_norflash_defconfig
new file mode 100644
index 0000000..5bd4b51
--- /dev/null
+++ b/configs/at91sam9g20kubos_2mmc_norflash_defconfig
@@ -0,0 +1,21 @@
+CONFIG_ARM=y
+CONFIG_ARCH_AT91=y
+CONFIG_TARGET_AT91SAM9G20KUBOS=y
+CONFIG_SYS_EXTRA_OPTIONS="AT91SAM9G20,SYS_USE_NORFLASH"
+CONFIG_BOOTDELAY=3
+CONFIG_SYS_PROMPT="U-Boot> "
+# CONFIG_CMD_BDI is not set
+CONFIG_CMD_BOOTZ=y
+# CONFIG_CMD_IMI is not set
+# CONFIG_CMD_IMLS is not set
+# CONFIG_CMD_LOADS is not set
+CONFIG_CMD_MMC=y
+CONFIG_CMD_USB=y
+# CONFIG_CMD_FPGA is not set
+# CONFIG_CMD_SOURCE is not set
+# CONFIG_CMD_SETEXPR is not set
+CONFIG_CMD_PING=y
+CONFIG_CMD_FAT=y
+CONFIG_USB=y
+CONFIG_USB_STORAGE=y
+CONFIG_OF_LIBFDT=y
diff --git a/include/configs/at91sam9g20kubos.h b/include/configs/at91sam9g20kubos.h
index 63a91bf..0cb3e6e 100644
--- a/include/configs/at91sam9g20kubos.h
+++ b/include/configs/at91sam9g20kubos.h
@@ -31,7 +31,7 @@
 
 /* Define actual evaluation board type from used processor type */
 #ifdef CONFIG_AT91SAM9G20
-# define CONFIG_AT91SAM9G20KUBOS	/* It's an Atmel AT91SAM9G20 EK */
+# define CONFIG_AT91SAM9G20KUBOS	/* It's a Kubos AT91SAM9G20*/
 #else
 #error Messed up board configuration!
 # define CONFIG_AT91SAM9260EK	/* It's an Atmel AT91SAM9260 EK */
@@ -58,6 +58,7 @@
 #define CONFIG_BAUDRATE			115200
 
 /* LED */
+/*TODO*/
 #define CONFIG_AT91_LED
 #define	CONFIG_RED_LED		AT91_PIN_PA9	/* this is the power led */
 #define	CONFIG_GREEN_LED	AT91_PIN_PA6	/* this is the user led */
@@ -134,21 +135,12 @@
 #endif
 #define DATAFLASH_TCHS			(0x1 << 24)
 
-/* NOR flash - Just changed 'NAND' to 'NOR'
- * TODO: Check ALL of these values... */
+/* NOR flash */
 #ifdef CONFIG_CMD_NOR
-#define CONFIG_NOR_ATMEL
-#define CONFIG_SYS_MAX_NOR_DEVICE	1
-#define CONFIG_SYS_NOR_BASE		ATMEL_BASE_CS3
-#define CONFIG_SYS__DBW_8
-#define CONFIG_SYS__MASK_ALE	(1 << 21)
-#define CONFIG_SYS__MASK_CLE	(1 << 22)
-#define CONFIG_SYS__ENABLE_PIN	AT91_PIN_PC14
-#define CONFIG_SYS__READY_PIN	AT91_PIN_PC13
+#define CONFIG_SYS_USE_NORFLASH 1
 #endif
 
-/* MMC */
-/* TODO: Turn this on?  I think it's SD card support */
+/* MMC - Turned on in defconfig file*/
 #ifdef CONFIG_CMD_MMC
 #define CONFIG_MMC
 #define CONFIG_GENERIC_MMC
@@ -160,9 +152,6 @@
 #define CONFIG_DOS_PARTITION
 #endif
 
-/* NOR flash - no real flash on this board */
-#define CONFIG_SYS_NO_FLASH			1
-
 /* USB */
 #define CONFIG_USB_ATMEL
 #define CONFIG_USB_ATMEL_CLK_SEL_PLLB
@@ -172,10 +161,10 @@
 #define CONFIG_SYS_USB_OHCI_SLOT_NAME		"at91sam9g20"
 #define CONFIG_SYS_USB_OHCI_MAX_ROOT_PORTS	2
 
-#define CONFIG_SYS_LOAD_ADDR			0x22000000	/* load address */
+#define CONFIG_SYS_LOAD_ADDR			0x22000000	/* load address TODO: verify */
 
 #define CONFIG_SYS_MEMTEST_START		CONFIG_SYS_SDRAM_BASE
-#define CONFIG_SYS_MEMTEST_END			0x23e00000
+#define CONFIG_SYS_MEMTEST_END			0x20e00000
 
 #ifdef CONFIG_SYS_USE_DATAFLASH_CS0
 
@@ -207,32 +196,29 @@
 
 #elif defined(CONFIG_SYS_USE_NORFLASH)
 
-/* bootstrap + u-boot + env + linux in flash */
+/* (bootstrap + u-boot + env in flash) + (linux in mmc) */
 /* TODO: This configuration could use some work...*/
 #define CONFIG_ENV_IS_IN_FLASH	1
 #define CONFIG_ENV_OFFSET		0xc0000
 #define CONFIG_ENV_SIZE		0x20000		/* 1 sector = 128 kB */
-#define CONFIG_BOOTCOMMAND	"cp.b 0x22000000 0x200000 0x300000; bootm"
+#define CONFIG_BOOTCOMMAND	"fatload mmc 0:1 0x22000000 zImage; bootm"
 #define CONFIG_BOOTARGS							\
 	"console=ttyS0,115200 earlyprintk "				\
-	"mtdparts=atmel_:256k(bootstrap)ro,512k(uboot)ro,"		\
-	"256k(env),256k(spare),"			\
-	"512k(dtb),6M(kernel)ro,-(rootfs) "				\
-	"root=/dev/mtdblock7 rw rootfstype=jffs2"
+	"root=/dev/mtdblock0 " \
+	"mtdparts=atmel_nand:-(root) "\
+	"root=/dev/mmcblk0p2 rw rootfstype=ext4 rootwait"
 
 #define CONFIG_SYS_FLASH_CFI			1
 #define CONFIG_FLASH_CFI_DRIVER			1
-#define PHYS_FLASH_1				0x10000000
+#define PHYS_FLASH_1				0x00100000
 #define CONFIG_SYS_FLASH_BASE			PHYS_FLASH_1
-#define CONFIG_SYS_MAX_FLASH_SECT		256
+#define CONFIG_SYS_MAX_FLASH_SECT		8
 #define CONFIG_SYS_MAX_FLASH_BANKS		1
 
+/*
 #define CONFIG_SYS_MONITOR_SEC	1:0-3
 #define CONFIG_SYS_MONITOR_BASE	CONFIG_SYS_FLASH_BASE
 #define CONFIG_SYS_MONITOR_LEN	(256 << 10)
-#define CONFIG_ENV_IS_IN_FLASH	1
-#define CONFIG_ENV_ADDR		(CONFIG_SYS_FLASH_BASE + 0x007E0000)
-/*#define CONFIG_ENV_ADDR_REDUND	(CONFIG_ENV_ADDR - CONFIG_ENV_SIZE)*/
 
 #define CONFIG_EXTRA_ENV_SETTINGS	\
 	"monitor_base=" __stringify(CONFIG_SYS_MONITOR_BASE) "\0" \
@@ -241,6 +227,7 @@
 		"erase ${monitor_base} +${filesize};" \
 		"cp.b ${fileaddr} ${monitor_base} ${filesize};" \
 		"protect on ${monitor_base} +${filesize}\0"
+*/
 
 #else	/* CONFIG_SYS_USE_MMC */
 /* bootstrap + u-boot + env + linux in mmc */
-- 
2.7.4


From 9c56126a2091b9d4324b1361b0cfaad1a919d976 Mon Sep 17 00:00:00 2001
From: catfreed <catherine@kubos.co>
Date: Fri, 14 Oct 2016 14:43:19 -0500
Subject: [PATCH 07/37] Updating config to load dtb and kernel

---
 include/configs/at91sam9g20kubos.h | 9 +++++++--
 1 file changed, 7 insertions(+), 2 deletions(-)

diff --git a/include/configs/at91sam9g20kubos.h b/include/configs/at91sam9g20kubos.h
index 0cb3e6e..4d92048 100644
--- a/include/configs/at91sam9g20kubos.h
+++ b/include/configs/at91sam9g20kubos.h
@@ -18,6 +18,8 @@
 #include <asm/hardware.h>
 
 /*
+ * CONFIG_SYS_TEXT_BASE - The starting address of U-Boot.  Currently set
+ * to the last MB of SDRAM.
  * Warning: changing CONFIG_SYS_TEXT_BASE requires
  * adapting the initial boot program.
  * Since the linker has to swallow that define, we must use a pure
@@ -196,12 +198,15 @@
 
 #elif defined(CONFIG_SYS_USE_NORFLASH)
 
-/* (bootstrap + u-boot + env in flash) + (linux in mmc) */
+/* (bootstrap + u-boot + env +dtb in flash) + (linux in mmc) */
 /* TODO: This configuration could use some work...*/
 #define CONFIG_ENV_IS_IN_FLASH	1
 #define CONFIG_ENV_OFFSET		0xc0000
 #define CONFIG_ENV_SIZE		0x20000		/* 1 sector = 128 kB */
-#define CONFIG_BOOTCOMMAND	"fatload mmc 0:1 0x22000000 zImage; bootm"
+/* Copy .dtb file and kernel into SDRAM, then boot them */
+#define CONFIG_BOOTCOMMAND	"cp.b 0x00070000 0x21800000 0x5000; " \
+				"fatload mmc 0:1 0x21880000 zImage; " \
+				"bootm 0x21880000 - 0x21800000"
 #define CONFIG_BOOTARGS							\
 	"console=ttyS0,115200 earlyprintk "				\
 	"root=/dev/mtdblock0 " \
-- 
2.7.4


From 11df50874df05e06185f2bb8fd977eadc6cdc3ef Mon Sep 17 00:00:00 2001
From: catfreed <catherine@kubos.co>
Date: Tue, 18 Oct 2016 14:30:25 -0500
Subject: [PATCH 08/37] Changing baudrate

---
 include/configs/at91sam9g20kubos.h | 12 ++++++------
 1 file changed, 6 insertions(+), 6 deletions(-)

diff --git a/include/configs/at91sam9g20kubos.h b/include/configs/at91sam9g20kubos.h
index 4d92048..2a2e82b 100644
--- a/include/configs/at91sam9g20kubos.h
+++ b/include/configs/at91sam9g20kubos.h
@@ -57,7 +57,7 @@
 #define CONFIG_ATMEL_USART
 #define CONFIG_USART_BASE		ATMEL_BASE_DBGU
 #define	CONFIG_USART_ID			ATMEL_ID_SYS
-#define CONFIG_BAUDRATE			115200
+#define CONFIG_BAUDRATE			2000000
 
 /* LED */
 /*TODO*/
@@ -177,7 +177,7 @@
 #define CONFIG_ENV_ADDR		(CONFIG_SYS_DATAFLASH_LOGIC_ADDR_CS0 + CONFIG_ENV_OFFSET)
 #define CONFIG_ENV_SIZE		0x4200
 #define CONFIG_BOOTCOMMAND	"cp.b 0xC0084000 0x22000000 0x210000; bootm"
-#define CONFIG_BOOTARGS		"console=ttyS0,115200 "			\
+#define CONFIG_BOOTARGS		"console=ttyS0,2000000 "			\
 				"root=/dev/mtdblock0 "			\
 				"mtdparts=atmel_:-(root) "		\
 				"rw rootfstype=jffs2"
@@ -191,7 +191,7 @@
 #define CONFIG_ENV_ADDR		(CONFIG_SYS_DATAFLASH_LOGIC_ADDR_CS1 + CONFIG_ENV_OFFSET)
 #define CONFIG_ENV_SIZE		0x4200
 #define CONFIG_BOOTCOMMAND	"cp.b 0xD0084000 0x22000000 0x210000; bootm"
-#define CONFIG_BOOTARGS		"console=ttyS0,115200 "			\
+#define CONFIG_BOOTARGS		"console=ttyS0,2000000 "			\
 				"root=/dev/mtdblock0 "			\
 				"mtdparts=atmel_:-(root) "		\
 				"rw rootfstype=jffs2"
@@ -201,14 +201,14 @@
 /* (bootstrap + u-boot + env +dtb in flash) + (linux in mmc) */
 /* TODO: This configuration could use some work...*/
 #define CONFIG_ENV_IS_IN_FLASH	1
-#define CONFIG_ENV_OFFSET		0xc0000
+#define CONFIG_ENV_OFFSET		0x50000
 #define CONFIG_ENV_SIZE		0x20000		/* 1 sector = 128 kB */
 /* Copy .dtb file and kernel into SDRAM, then boot them */
 #define CONFIG_BOOTCOMMAND	"cp.b 0x00070000 0x21800000 0x5000; " \
 				"fatload mmc 0:1 0x21880000 zImage; " \
 				"bootm 0x21880000 - 0x21800000"
 #define CONFIG_BOOTARGS							\
-	"console=ttyS0,115200 earlyprintk "				\
+	"console=ttyS0,2000000 earlyprintk "				\
 	"root=/dev/mtdblock0 " \
 	"mtdparts=atmel_nand:-(root) "\
 	"root=/dev/mmcblk0p2 rw rootfstype=ext4 rootwait"
@@ -245,7 +245,7 @@
 #define CONFIG_BOOTCOMMAND						\
 	"fatload mmc 0:1 0x22000000 uImage; bootm"
 #define CONFIG_BOOTARGS							\
-	"console=ttyS0,115200 earlyprintk "				\
+	"console=ttyS0,2000000 earlyprintk "				\
 	"mtdparts=atmel_:256k(bootstrap)ro,512k(uboot)ro,"		\
 	"256k(env),256k(env_redundant),256k(spare),"			\
 	"512k(dtb),6M(kernel)ro,-(rootfs) "				\
-- 
2.7.4


From 5777ad0424e8fd7ebfd4879db493872a0546dca0 Mon Sep 17 00:00:00 2001
From: catfreed <catherine@kubos.co>
Date: Wed, 19 Oct 2016 10:41:26 -0500
Subject: [PATCH 09/37] Turning on debug and adjusting starting location

---
 include/common.h                   | 2 ++
 include/configs/at91sam9g20kubos.h | 2 +-
 2 files changed, 3 insertions(+), 1 deletion(-)

diff --git a/include/common.h b/include/common.h
index a8d833b..dd65eca 100644
--- a/include/common.h
+++ b/include/common.h
@@ -95,6 +95,8 @@ typedef volatile unsigned char	vu_char;
 #define CONFIG_SYS_SUPPORT_64BIT_DATA
 #endif
 
+#define DEBUG 1
+
 #ifdef DEBUG
 #define _DEBUG	1
 #else
diff --git a/include/configs/at91sam9g20kubos.h b/include/configs/at91sam9g20kubos.h
index 2a2e82b..2e84570 100644
--- a/include/configs/at91sam9g20kubos.h
+++ b/include/configs/at91sam9g20kubos.h
@@ -25,7 +25,7 @@
  * Since the linker has to swallow that define, we must use a pure
  * hex number here!
  */
-#define CONFIG_SYS_TEXT_BASE		0x21f00000
+#define CONFIG_SYS_TEXT_BASE		0x20000000
 
 /* ARM asynchronous clock */
 #define CONFIG_SYS_AT91_SLOW_CLOCK	32768		/* slow clock xtal */
-- 
2.7.4


From 98caf15eb60ed96288f45f440f7068518853b8c7 Mon Sep 17 00:00:00 2001
From: catfreed <catherine@kubos.co>
Date: Fri, 21 Oct 2016 11:23:35 -0500
Subject: [PATCH 10/37] Turning on CONFIG_MMC_TRACE

---
 include/configs/at91sam9g20kubos.h | 1 +
 1 file changed, 1 insertion(+)

diff --git a/include/configs/at91sam9g20kubos.h b/include/configs/at91sam9g20kubos.h
index 2e84570..6e0adbd 100644
--- a/include/configs/at91sam9g20kubos.h
+++ b/include/configs/at91sam9g20kubos.h
@@ -145,6 +145,7 @@
 /* MMC - Turned on in defconfig file*/
 #ifdef CONFIG_CMD_MMC
 #define CONFIG_MMC
+#deifne CONFIG_MMC_TRACE
 #define CONFIG_GENERIC_MMC
 #define CONFIG_GENERIC_ATMEL_MCI
 #endif
-- 
2.7.4


From e12b3868e39583d1d44ae56093950c8e4c54c3c6 Mon Sep 17 00:00:00 2001
From: catfreed <catherine@kubos.co>
Date: Fri, 21 Oct 2016 16:48:36 -0500
Subject: [PATCH 11/37] Adding spcmd init processing

---
 board/kubos/at91sam9g20kubos/at91sam9g20kubos.c |  22 ++++
 drivers/mmc/gen_atmel_mci.c                     | 142 ++++++++++++++++++++++++
 drivers/mmc/mmc.c                               |  20 ++++
 include/configs/at91sam9g20kubos.h              |   2 +-
 include/mmc.h                                   |   2 +
 5 files changed, 187 insertions(+), 1 deletion(-)

diff --git a/board/kubos/at91sam9g20kubos/at91sam9g20kubos.c b/board/kubos/at91sam9g20kubos/at91sam9g20kubos.c
index a9b95e4..305af5c 100644
--- a/board/kubos/at91sam9g20kubos/at91sam9g20kubos.c
+++ b/board/kubos/at91sam9g20kubos/at91sam9g20kubos.c
@@ -168,3 +168,25 @@ int board_eth_init(bd_t *bis)
 #endif
 	return rc;
 }
+
+
+void board_mmc_power_init(void)
+{
+	struct mmc_cmd cmd;
+	int err;
+	
+	debug("board_mmc_power_init start\r\n");
+
+	udelay(1000);
+
+	cmd.cmdidx = MMC_CMD_GO_IDLE_STATE;
+	cmd.resp_type = MMC_RSP_NONE;
+	cmd.cmdarg = 0;
+
+	err = mmc_send_spcmd(mmc, &cmd, NULL);
+
+	if (err)
+		debug("board_mmc_power_init err=%\r\n", err);
+
+	udelay(2000);
+}
diff --git a/drivers/mmc/gen_atmel_mci.c b/drivers/mmc/gen_atmel_mci.c
index cca0b04..5200f5d 100644
--- a/drivers/mmc/gen_atmel_mci.c
+++ b/drivers/mmc/gen_atmel_mci.c
@@ -335,6 +335,147 @@ mci_send_cmd(struct mmc *mmc, struct mmc_cmd *cmd, struct mmc_data *data)
 	return 0;
 }
 
+/*
+ * Entered into mmc structure during driver init
+ *
+ * Sends a command out on the bus and deals with the block data.
+ * Takes the mmc pointer, a command pointer, and an optional data pointer.
+ */
+static int
+mci_send_sp_cmd(struct mmc *mmc, struct mmc_cmd *cmd, struct mmc_data *data)
+{
+	struct atmel_mci_priv *priv = mmc->priv;
+	atmel_mci_t *mci = priv->mci;
+	u32 cmdr;
+	u32 error_flags = 0;
+	u32 status;
+
+	if (!priv->initialized) {
+		puts ("MCI not initialized!\n");
+		return -ECOMM;
+	}
+
+	/* Figure out the transfer arguments */
+	cmdr = mci_encode_cmd(cmd, data, &error_flags);
+
+	/* For multi blocks read/write, set the block register */
+	if ((cmd->cmdidx == MMC_CMD_READ_MULTIPLE_BLOCK)
+			|| (cmd->cmdidx == MMC_CMD_WRITE_MULTIPLE_BLOCK))
+		writel(data->blocks | MMCI_BF(BLKLEN, mmc->read_bl_len),
+			&mci->blkr);
+
+	cmdr |= MMCI_BF(SPCMD, 1);
+
+	/* Send the command */
+	writel(cmd->cmdarg, &mci->argr);
+	writel(cmdr, &mci->cmdr);
+
+#ifdef DEBUG
+	dump_cmd(cmdr, cmd->cmdarg, 0, "DEBUG");
+#endif
+
+	/* Wait for the command to complete */
+	while (!((status = readl(&mci->sr)) & MMCI_BIT(CMDRDY)));
+
+	if ((status & error_flags) & MMCI_BIT(RTOE)) {
+		dump_cmd(cmdr, cmd->cmdarg, status, "Command Time Out");
+		return -ETIMEDOUT;
+	} else if (status & error_flags) {
+		dump_cmd(cmdr, cmd->cmdarg, status, "Command Failed");
+		return -ECOMM;
+	}
+
+	/* Copy the response to the response buffer */
+	if (cmd->resp_type & MMC_RSP_136) {
+		cmd->response[0] = readl(&mci->rspr);
+		cmd->response[1] = readl(&mci->rspr1);
+		cmd->response[2] = readl(&mci->rspr2);
+		cmd->response[3] = readl(&mci->rspr3);
+	} else
+		cmd->response[0] = readl(&mci->rspr);
+
+	/* transfer all of the blocks */
+	if (data) {
+		u32 word_count, block_count;
+		u32* ioptr;
+		u32 sys_blocksize, dummy, i;
+		u32 (*mci_data_op)
+			(atmel_mci_t *mci, u32* data, u32 error_flags);
+
+		if (data->flags & MMC_DATA_READ) {
+			mci_data_op = mci_data_read;
+			sys_blocksize = mmc->read_bl_len;
+			ioptr = (u32*)data->dest;
+		} else {
+			mci_data_op = mci_data_write;
+			sys_blocksize = mmc->write_bl_len;
+			ioptr = (u32*)data->src;
+		}
+
+		status = 0;
+		for (block_count = 0;
+				block_count < data->blocks && !status;
+				block_count++) {
+			word_count = 0;
+			do {
+				status = mci_data_op(mci, ioptr, error_flags);
+				word_count++;
+				ioptr++;
+			} while (!status && word_count < (data->blocksize/4));
+#ifdef DEBUG
+			if (data->flags & MMC_DATA_READ)
+			{
+				u32 cnt = word_count * 4;
+				printf("Read Data:\n");
+				print_buffer(0, data->dest + cnt * block_count,
+					     1, cnt, 0);
+			}
+#endif
+#ifdef DEBUG
+			if (!status && word_count < (sys_blocksize / 4))
+				printf("filling rest of block...\n");
+#endif
+			/* fill the rest of a full block */
+			while (!status && word_count < (sys_blocksize / 4)) {
+				status = mci_data_op(mci, &dummy,
+					error_flags);
+				word_count++;
+			}
+			if (status) {
+				dump_cmd(cmdr, cmd->cmdarg, status,
+					"Data Transfer Failed");
+				return -ECOMM;
+			}
+		}
+
+		/* Wait for Transfer End */
+		i = 0;
+		do {
+			status = readl(&mci->sr);
+
+			if (status & error_flags) {
+				dump_cmd(cmdr, cmd->cmdarg, status,
+					"DTIP Wait Failed");
+				return -ECOMM;
+			}
+			i++;
+		} while ((status & MMCI_BIT(DTIP)) && i < 10000);
+		if (status & MMCI_BIT(DTIP)) {
+			dump_cmd(cmdr, cmd->cmdarg, status,
+				"XFER DTIP never unset, ignoring");
+		}
+	}
+
+	/*
+	 * After the switch command, wait for 8 clocks before the next
+	 * command
+	 */
+	if (cmd->cmdidx == MMC_CMD_SWITCH)
+		udelay(8*1000000 / priv->curr_clk); /* 8 clk in us */
+
+	return 0;
+}
+
 /* Entered into mmc structure during driver init */
 static void mci_set_ios(struct mmc *mmc)
 {
@@ -399,6 +540,7 @@ static const struct mmc_ops atmel_mci_ops = {
 	.send_cmd	= mci_send_cmd,
 	.set_ios	= mci_set_ios,
 	.init		= mci_init,
+	.send_spcmd = mci_send_spcmd,
 };
 
 /*
diff --git a/drivers/mmc/mmc.c b/drivers/mmc/mmc.c
index 0312da9..5e6157c 100644
--- a/drivers/mmc/mmc.c
+++ b/drivers/mmc/mmc.c
@@ -136,6 +136,17 @@ int mmc_send_cmd(struct mmc *mmc, struct mmc_cmd *cmd, struct mmc_data *data)
 
 	return ret;
 }
+
+int mmc_send_spcmd(struct mmc *mmc, struct mmc_cmd *cmd, struct mmc_data *data)
+{
+	int ret;
+
+	mmmc_trace_before_send(mmc, cmd);
+	ret = mmc->cfg->ops->send_spcmd(mmc, cmd, data);
+	mmmc_trace_after_send(mmc, cmd, ret);
+
+	return ret;
+}
 #endif
 
 int mmc_send_status(struct mmc *mmc, int timeout)
@@ -1567,12 +1578,21 @@ static int mmc_send_if_cond(struct mmc *mmc)
 	err = mmc_send_cmd(mmc, &cmd, NULL);
 
 	if (err)
+	{
+		debug("mmc_send_if_cond err = %d\r\n", err);
 		return err;
+	}
 
 	if ((cmd.response[0] & 0xff) != 0xaa)
+	{
+		debug("mmc_send_if_cond EOPNOTSUPP\r\n");
 		return -EOPNOTSUPP;
+	}
 	else
+	{
+		debug("mmc_send_if_cond setting SD_VERSION_2\r\n");
 		mmc->version = SD_VERSION_2;
+	}
 
 	return 0;
 }
diff --git a/include/configs/at91sam9g20kubos.h b/include/configs/at91sam9g20kubos.h
index 6e0adbd..b2e5198 100644
--- a/include/configs/at91sam9g20kubos.h
+++ b/include/configs/at91sam9g20kubos.h
@@ -145,7 +145,7 @@
 /* MMC - Turned on in defconfig file*/
 #ifdef CONFIG_CMD_MMC
 #define CONFIG_MMC
-#deifne CONFIG_MMC_TRACE
+#define CONFIG_MMC_TRACE
 #define CONFIG_GENERIC_MMC
 #define CONFIG_GENERIC_ATMEL_MCI
 #endif
diff --git a/include/mmc.h b/include/mmc.h
index e815eb3..f10922e 100644
--- a/include/mmc.h
+++ b/include/mmc.h
@@ -378,6 +378,8 @@ struct mmc_ops {
 	int (*init)(struct mmc *mmc);
 	int (*getcd)(struct mmc *mmc);
 	int (*getwp)(struct mmc *mmc);
+	int (*send_spcmd)(struct mmc *mmc,
+			struct mmc_cmd *cmd, struct mmc_data *data);
 };
 #endif
 
-- 
2.7.4


From d9efb3dcdb418b1a97a6b2353bf2c80cc16e3d3e Mon Sep 17 00:00:00 2001
From: catfreed <catherine@kubos.co>
Date: Mon, 24 Oct 2016 09:23:05 -0500
Subject: [PATCH 12/37] Adding SPCMD init

---
 board/kubos/at91sam9g20kubos/at91sam9g20kubos.c |  4 +++-
 drivers/mmc/mmc.c                               | 10 ++++++++++
 include/mmc.h                                   |  1 +
 3 files changed, 14 insertions(+), 1 deletion(-)

diff --git a/board/kubos/at91sam9g20kubos/at91sam9g20kubos.c b/board/kubos/at91sam9g20kubos/at91sam9g20kubos.c
index 305af5c..78672e2 100644
--- a/board/kubos/at91sam9g20kubos/at91sam9g20kubos.c
+++ b/board/kubos/at91sam9g20kubos/at91sam9g20kubos.c
@@ -14,6 +14,8 @@
 #include <asm/arch/clk.h>
 #include <asm/arch/gpio.h>
 #include <atmel_mci.h>
+#include <mmc.h>
+#include "mmc_private.h"
 
 #if defined(CONFIG_RESET_PHY_R) && defined(CONFIG_MACB)
 # include <net.h>
@@ -170,7 +172,7 @@ int board_eth_init(bd_t *bis)
 }
 
 
-void board_mmc_power_init(void)
+void board_kubos_mmc_power_init(struct mmc *mmc)
 {
 	struct mmc_cmd cmd;
 	int err;
diff --git a/drivers/mmc/mmc.c b/drivers/mmc/mmc.c
index 5e6157c..74b11ae 100644
--- a/drivers/mmc/mmc.c
+++ b/drivers/mmc/mmc.c
@@ -1602,6 +1602,11 @@ __weak void board_mmc_power_init(void)
 {
 }
 
+/* board-specific MMC power initializations. */
+__weak void board_power_mmc_power_init(void)
+{
+}
+
 int mmc_start_init(struct mmc *mmc)
 {
 	bool no_card;
@@ -1626,7 +1631,12 @@ int mmc_start_init(struct mmc *mmc)
 #ifdef CONFIG_FSL_ESDHC_ADAPTER_IDENT
 	mmc_adapter_card_type_ident();
 #endif
+
+#ifdef CONFIG_AT91SAM9G20KUBOS
+	board_kubos_mmc_power_init(mmc);
+#else
 	board_mmc_power_init();
+#endif
 
 #ifdef CONFIG_DM_MMC_OPS
 	/* The device has already been probed ready for use */
diff --git a/include/mmc.h b/include/mmc.h
index f10922e..a9b4038 100644
--- a/include/mmc.h
+++ b/include/mmc.h
@@ -575,6 +575,7 @@ void mmc_set_preinit(struct mmc *mmc, int preinit);
 struct mmc *mmc_spi_init(uint bus, uint cs, uint speed, uint mode);
 
 void board_mmc_power_init(void);
+void board_kubos_mmc_power_init(struct mmc *mmc);
 int board_mmc_init(bd_t *bis);
 int cpu_mmc_init(bd_t *bis);
 int mmc_get_env_addr(struct mmc *mmc, int copy, u32 *env_addr);
-- 
2.7.4


From 01bb273a0b1b6bb4497c86248a0a1554b5cb50e0 Mon Sep 17 00:00:00 2001
From: catfreed <catherine@kubos.co>
Date: Mon, 24 Oct 2016 09:58:52 -0500
Subject: [PATCH 13/37] Fixing things

---
 board/kubos/at91sam9g20kubos/at91sam9g20kubos.c | 3 +--
 drivers/mmc/gen_atmel_mci.c                     | 4 +++-
 2 files changed, 4 insertions(+), 3 deletions(-)

diff --git a/board/kubos/at91sam9g20kubos/at91sam9g20kubos.c b/board/kubos/at91sam9g20kubos/at91sam9g20kubos.c
index 78672e2..65ea13e 100644
--- a/board/kubos/at91sam9g20kubos/at91sam9g20kubos.c
+++ b/board/kubos/at91sam9g20kubos/at91sam9g20kubos.c
@@ -15,7 +15,6 @@
 #include <asm/arch/gpio.h>
 #include <atmel_mci.h>
 #include <mmc.h>
-#include "mmc_private.h"
 
 #if defined(CONFIG_RESET_PHY_R) && defined(CONFIG_MACB)
 # include <net.h>
@@ -188,7 +187,7 @@ void board_kubos_mmc_power_init(struct mmc *mmc)
 	err = mmc_send_spcmd(mmc, &cmd, NULL);
 
 	if (err)
-		debug("board_mmc_power_init err=%\r\n", err);
+		debug("board_mmc_power_init err=%d\r\n", err);
 
 	udelay(2000);
 }
diff --git a/drivers/mmc/gen_atmel_mci.c b/drivers/mmc/gen_atmel_mci.c
index 5200f5d..a6a8965 100644
--- a/drivers/mmc/gen_atmel_mci.c
+++ b/drivers/mmc/gen_atmel_mci.c
@@ -216,6 +216,8 @@ mci_send_cmd(struct mmc *mmc, struct mmc_cmd *cmd, struct mmc_data *data)
 		return -ECOMM;
 	}
 
+	debug("mci_send_cmd\r\n");
+
 	/* Figure out the transfer arguments */
 	cmdr = mci_encode_cmd(cmd, data, &error_flags);
 
@@ -540,7 +542,7 @@ static const struct mmc_ops atmel_mci_ops = {
 	.send_cmd	= mci_send_cmd,
 	.set_ios	= mci_set_ios,
 	.init		= mci_init,
-	.send_spcmd = mci_send_spcmd,
+	.send_spcmd = mci_send_sp_cmd,
 };
 
 /*
-- 
2.7.4


From af8140bc490e9cbb74195282e0c5b1c03fe65082 Mon Sep 17 00:00:00 2001
From: catfreed <catherine@kubos.co>
Date: Mon, 24 Oct 2016 10:19:50 -0500
Subject: [PATCH 14/37] Fixing more things

---
 board/kubos/at91sam9g20kubos/at91sam9g20kubos.c |  4 ++--
 drivers/mmc/gen_atmel_mci.c                     |  7 +++++--
 drivers/mmc/mmc.c                               | 10 ++++++----
 3 files changed, 13 insertions(+), 8 deletions(-)

diff --git a/board/kubos/at91sam9g20kubos/at91sam9g20kubos.c b/board/kubos/at91sam9g20kubos/at91sam9g20kubos.c
index 65ea13e..b7446bd 100644
--- a/board/kubos/at91sam9g20kubos/at91sam9g20kubos.c
+++ b/board/kubos/at91sam9g20kubos/at91sam9g20kubos.c
@@ -176,7 +176,7 @@ void board_kubos_mmc_power_init(struct mmc *mmc)
 	struct mmc_cmd cmd;
 	int err;
 	
-	debug("board_mmc_power_init start\r\n");
+	debug("board_kubos_mmc_power_init start\r\n");
 
 	udelay(1000);
 
@@ -187,7 +187,7 @@ void board_kubos_mmc_power_init(struct mmc *mmc)
 	err = mmc_send_spcmd(mmc, &cmd, NULL);
 
 	if (err)
-		debug("board_mmc_power_init err=%d\r\n", err);
+		debug("board_kubos_mmc_power_init err=%d\r\n", err);
 
 	udelay(2000);
 }
diff --git a/drivers/mmc/gen_atmel_mci.c b/drivers/mmc/gen_atmel_mci.c
index a6a8965..63c161b 100644
--- a/drivers/mmc/gen_atmel_mci.c
+++ b/drivers/mmc/gen_atmel_mci.c
@@ -211,13 +211,14 @@ mci_send_cmd(struct mmc *mmc, struct mmc_cmd *cmd, struct mmc_data *data)
 	u32 error_flags = 0;
 	u32 status;
 
+
+	debug("mci_send_cmd\r\n");
+
 	if (!priv->initialized) {
 		puts ("MCI not initialized!\n");
 		return -ECOMM;
 	}
 
-	debug("mci_send_cmd\r\n");
-
 	/* Figure out the transfer arguments */
 	cmdr = mci_encode_cmd(cmd, data, &error_flags);
 
@@ -352,6 +353,8 @@ mci_send_sp_cmd(struct mmc *mmc, struct mmc_cmd *cmd, struct mmc_data *data)
 	u32 error_flags = 0;
 	u32 status;
 
+	debug("mci_send_sp_cmd\r\n");
+
 	if (!priv->initialized) {
 		puts ("MCI not initialized!\n");
 		return -ECOMM;
diff --git a/drivers/mmc/mmc.c b/drivers/mmc/mmc.c
index 74b11ae..8031baa 100644
--- a/drivers/mmc/mmc.c
+++ b/drivers/mmc/mmc.c
@@ -141,6 +141,8 @@ int mmc_send_spcmd(struct mmc *mmc, struct mmc_cmd *cmd, struct mmc_data *data)
 {
 	int ret;
 
+	debug("mmc_send_spcmd\r\n");
+
 	mmmc_trace_before_send(mmc, cmd);
 	ret = mmc->cfg->ops->send_spcmd(mmc, cmd, data);
 	mmmc_trace_after_send(mmc, cmd, ret);
@@ -1632,11 +1634,7 @@ int mmc_start_init(struct mmc *mmc)
 	mmc_adapter_card_type_ident();
 #endif
 
-#ifdef CONFIG_AT91SAM9G20KUBOS
-	board_kubos_mmc_power_init(mmc);
-#else
 	board_mmc_power_init();
-#endif
 
 #ifdef CONFIG_DM_MMC_OPS
 	/* The device has already been probed ready for use */
@@ -1650,6 +1648,10 @@ int mmc_start_init(struct mmc *mmc)
 	mmc_set_bus_width(mmc, 1);
 	mmc_set_clock(mmc, 1);
 
+#ifdef CONFIG_AT91SAM9G20KUBOS
+	board_kubos_mmc_power_init(mmc);
+#endif
+
 	/* Reset the Card */
 	err = mmc_go_idle(mmc);
 
-- 
2.7.4


From 1d2136f07dcc619cc9e1cdced9b37abd56783970 Mon Sep 17 00:00:00 2001
From: catfreed <catherine@kubos.co>
Date: Mon, 24 Oct 2016 14:10:32 -0500
Subject: [PATCH 15/37] Commenting out SPCMD

---
 board/kubos/at91sam9g20kubos/at91sam9g20kubos.c | 4 ++--
 1 file changed, 2 insertions(+), 2 deletions(-)

diff --git a/board/kubos/at91sam9g20kubos/at91sam9g20kubos.c b/board/kubos/at91sam9g20kubos/at91sam9g20kubos.c
index b7446bd..1f8fff0 100644
--- a/board/kubos/at91sam9g20kubos/at91sam9g20kubos.c
+++ b/board/kubos/at91sam9g20kubos/at91sam9g20kubos.c
@@ -173,7 +173,7 @@ int board_eth_init(bd_t *bis)
 
 void board_kubos_mmc_power_init(struct mmc *mmc)
 {
-	struct mmc_cmd cmd;
+/*	struct mmc_cmd cmd;
 	int err;
 	
 	debug("board_kubos_mmc_power_init start\r\n");
@@ -189,5 +189,5 @@ void board_kubos_mmc_power_init(struct mmc *mmc)
 	if (err)
 		debug("board_kubos_mmc_power_init err=%d\r\n", err);
 
-	udelay(2000);
+	udelay(2000);*/
 }
-- 
2.7.4


From 7bfaea0475aac28f43fc63f80a308a3431c0da27 Mon Sep 17 00:00:00 2001
From: catfreed <catherine@kubos.co>
Date: Mon, 24 Oct 2016 15:30:27 -0500
Subject: [PATCH 16/37] Testing mmc->high_capacity

---
 drivers/mmc/mmc.c | 5 +++++
 1 file changed, 5 insertions(+)

diff --git a/drivers/mmc/mmc.c b/drivers/mmc/mmc.c
index 8031baa..0850e97 100644
--- a/drivers/mmc/mmc.c
+++ b/drivers/mmc/mmc.c
@@ -1594,6 +1594,7 @@ static int mmc_send_if_cond(struct mmc *mmc)
 	{
 		debug("mmc_send_if_cond setting SD_VERSION_2\r\n");
 		mmc->version = SD_VERSION_2;
+		mmc->high_capacity = 1;
 	}
 
 	return 0;
@@ -1691,7 +1692,11 @@ static int mmc_complete_init(struct mmc *mmc)
 
 	mmc->init_in_progress = 0;
 	if (mmc->op_cond_pending)
+	{
 		err = mmc_complete_op_cond(mmc);
+		//TEST: Force SDHC
+		mmc->high_capacity = 1;
+	}
 
 	if (!err)
 		err = mmc_startup(mmc);
-- 
2.7.4


From 356641f76656c30afe0e9c8f135b2e1117199d85 Mon Sep 17 00:00:00 2001
From: catfreed <catherine@kubos.co>
Date: Mon, 24 Oct 2016 16:47:00 -0500
Subject: [PATCH 17/37] Forcing high-capacity

---
 drivers/mmc/mmc.c | 10 ++++++++++
 1 file changed, 10 insertions(+)

diff --git a/drivers/mmc/mmc.c b/drivers/mmc/mmc.c
index 0850e97..cab9712 100644
--- a/drivers/mmc/mmc.c
+++ b/drivers/mmc/mmc.c
@@ -221,9 +221,15 @@ static int mmc_read_blocks(struct mmc *mmc, void *dst, lbaint_t start,
 		cmd.cmdidx = MMC_CMD_READ_SINGLE_BLOCK;
 
 	if (mmc->high_capacity)
+	{
+		debug("Reading high-capacity\r\n");
 		cmd.cmdarg = start;
+	}
 	else
+	{
+		debg("Not reading high-capacity\r\n");
 		cmd.cmdarg = start * mmc->read_bl_len;
+	}
 
 	cmd.resp_type = MMC_RSP_R1;
 
@@ -387,6 +393,8 @@ static int sd_send_op_cond(struct mmc *mmc)
 	mmc->ocr = cmd.response[0];
 
 	mmc->high_capacity = ((mmc->ocr & OCR_HCS) == OCR_HCS);
+	//TEST
+	mmc->high_capacity = 1;
 	mmc->rca = 0;
 
 	return 0;
@@ -475,6 +483,8 @@ static int mmc_complete_op_cond(struct mmc *mmc)
 	mmc->version = MMC_VERSION_UNKNOWN;
 
 	mmc->high_capacity = ((mmc->ocr & OCR_HCS) == OCR_HCS);
+	//TEST
+	mmc->high_capacity = 1;
 	mmc->rca = 1;
 
 	return 0;
-- 
2.7.4


From 624d5e43aaea332500814fd77ffecffa7b7df677 Mon Sep 17 00:00:00 2001
From: catfreed <catherine@kubos.co>
Date: Mon, 24 Oct 2016 16:58:15 -0500
Subject: [PATCH 18/37] Revert "Testing mmc->high_capacity"

This reverts commit 7bfaea0475aac28f43fc63f80a308a3431c0da27.
---
 drivers/mmc/mmc.c | 5 -----
 1 file changed, 5 deletions(-)

diff --git a/drivers/mmc/mmc.c b/drivers/mmc/mmc.c
index cab9712..b259fb0 100644
--- a/drivers/mmc/mmc.c
+++ b/drivers/mmc/mmc.c
@@ -1604,7 +1604,6 @@ static int mmc_send_if_cond(struct mmc *mmc)
 	{
 		debug("mmc_send_if_cond setting SD_VERSION_2\r\n");
 		mmc->version = SD_VERSION_2;
-		mmc->high_capacity = 1;
 	}
 
 	return 0;
@@ -1702,11 +1701,7 @@ static int mmc_complete_init(struct mmc *mmc)
 
 	mmc->init_in_progress = 0;
 	if (mmc->op_cond_pending)
-	{
 		err = mmc_complete_op_cond(mmc);
-		//TEST: Force SDHC
-		mmc->high_capacity = 1;
-	}
 
 	if (!err)
 		err = mmc_startup(mmc);
-- 
2.7.4


From 972710f43b62aaf6224b06cea15ccda1c1173d55 Mon Sep 17 00:00:00 2001
From: catfreed <catherine@kubos.co>
Date: Tue, 25 Oct 2016 09:34:52 -0500
Subject: [PATCH 19/37] Removing more HC test lines

---
 drivers/mmc/mmc.c | 4 ----
 1 file changed, 4 deletions(-)

diff --git a/drivers/mmc/mmc.c b/drivers/mmc/mmc.c
index b259fb0..5006770 100644
--- a/drivers/mmc/mmc.c
+++ b/drivers/mmc/mmc.c
@@ -393,8 +393,6 @@ static int sd_send_op_cond(struct mmc *mmc)
 	mmc->ocr = cmd.response[0];
 
 	mmc->high_capacity = ((mmc->ocr & OCR_HCS) == OCR_HCS);
-	//TEST
-	mmc->high_capacity = 1;
 	mmc->rca = 0;
 
 	return 0;
@@ -483,8 +481,6 @@ static int mmc_complete_op_cond(struct mmc *mmc)
 	mmc->version = MMC_VERSION_UNKNOWN;
 
 	mmc->high_capacity = ((mmc->ocr & OCR_HCS) == OCR_HCS);
-	//TEST
-	mmc->high_capacity = 1;
 	mmc->rca = 1;
 
 	return 0;
-- 
2.7.4


From 5467a9cdb9e8abf4ebab94a7d26d870d427c6bf8 Mon Sep 17 00:00:00 2001
From: catfreed <catherine@kubos.co>
Date: Tue, 25 Oct 2016 15:46:42 -0500
Subject: [PATCH 20/37] Trying SD Port B

---
 board/kubos/at91sam9g20kubos/at91sam9g20kubos.c | 21 +++++++++++++++++++--
 drivers/mmc/mmc.c                               |  2 +-
 include/configs/at91sam9g20kubos.h              |  2 ++
 3 files changed, 22 insertions(+), 3 deletions(-)

diff --git a/board/kubos/at91sam9g20kubos/at91sam9g20kubos.c b/board/kubos/at91sam9g20kubos/at91sam9g20kubos.c
index 1f8fff0..602e621 100644
--- a/board/kubos/at91sam9g20kubos/at91sam9g20kubos.c
+++ b/board/kubos/at91sam9g20kubos/at91sam9g20kubos.c
@@ -111,11 +111,28 @@ static void at91sam9g20kubos_macb_hw_init(void)
 #endif
 
 #ifdef CONFIG_GENERIC_ATMEL_MCI
+/* this is a weak define that we are overriding */
 int board_mmc_init(bd_t *bd)
 {
-	at91_mci_hw_init();
+       /* Enable clock */
+       at91_mci_hw_init();
 
-	return atmel_mci_init((void *)ATMEL_BASE_MCI);
+       /* This calls the atmel_mci_init in gen_atmel_mci.c */
+       return atmel_mci_init((void *)AT91_BASE_MCI);
+}
+
+/* this is a weak define that we are overriding */
+int board_mmc_getcd(u8 *cd, struct mmc *mmc)
+{
+       /*
+        * the only currently existing use of this function
+        * (fsl_esdhc.c) suggests this function must return
+        * *cs = TRUE if a card is NOT detected -> in most
+        * cases the value of the pin when the detect switch
+        * closes to GND
+        */
+       *cd = at91_get_gpio_value (CONFIG_SYS_MMC_CD_PIN) ? 1 : 0;
+       return 0;
 }
 #endif
 
diff --git a/drivers/mmc/mmc.c b/drivers/mmc/mmc.c
index 5006770..d3f0555 100644
--- a/drivers/mmc/mmc.c
+++ b/drivers/mmc/mmc.c
@@ -227,7 +227,7 @@ static int mmc_read_blocks(struct mmc *mmc, void *dst, lbaint_t start,
 	}
 	else
 	{
-		debg("Not reading high-capacity\r\n");
+		debug("Not reading high-capacity\r\n");
 		cmd.cmdarg = start * mmc->read_bl_len;
 	}
 
diff --git a/include/configs/at91sam9g20kubos.h b/include/configs/at91sam9g20kubos.h
index b2e5198..c5d9bff 100644
--- a/include/configs/at91sam9g20kubos.h
+++ b/include/configs/at91sam9g20kubos.h
@@ -148,6 +148,8 @@
 #define CONFIG_MMC_TRACE
 #define CONFIG_GENERIC_MMC
 #define CONFIG_GENERIC_ATMEL_MCI
+#define CONFIG_SYS_MMC_CD_PIN	AT91_PIN_PC9
+#define CONFIG_ATMEL_MCI_PORTB
 #endif
 
 /* FAT */
-- 
2.7.4


From e25c12e62c3ef79e1c7724441041f1b18423719d Mon Sep 17 00:00:00 2001
From: catfreed <catherine@kubos.co>
Date: Tue, 25 Oct 2016 16:00:16 -0500
Subject: [PATCH 21/37] Removing new init code

---
 board/kubos/at91sam9g20kubos/at91sam9g20kubos.c | 20 ++------------------
 1 file changed, 2 insertions(+), 18 deletions(-)

diff --git a/board/kubos/at91sam9g20kubos/at91sam9g20kubos.c b/board/kubos/at91sam9g20kubos/at91sam9g20kubos.c
index 602e621..2491f5c 100644
--- a/board/kubos/at91sam9g20kubos/at91sam9g20kubos.c
+++ b/board/kubos/at91sam9g20kubos/at91sam9g20kubos.c
@@ -114,25 +114,9 @@ static void at91sam9g20kubos_macb_hw_init(void)
 /* this is a weak define that we are overriding */
 int board_mmc_init(bd_t *bd)
 {
-       /* Enable clock */
-       at91_mci_hw_init();
+	at91_mci_hw_init();
 
-       /* This calls the atmel_mci_init in gen_atmel_mci.c */
-       return atmel_mci_init((void *)AT91_BASE_MCI);
-}
-
-/* this is a weak define that we are overriding */
-int board_mmc_getcd(u8 *cd, struct mmc *mmc)
-{
-       /*
-        * the only currently existing use of this function
-        * (fsl_esdhc.c) suggests this function must return
-        * *cs = TRUE if a card is NOT detected -> in most
-        * cases the value of the pin when the detect switch
-        * closes to GND
-        */
-       *cd = at91_get_gpio_value (CONFIG_SYS_MMC_CD_PIN) ? 1 : 0;
-       return 0;
+	return atmel_mci_init((void *)ATMEL_BASE_MCI);
 }
 #endif
 
-- 
2.7.4


From 575efd5c7de1e657ee004a0d2b45f257b44aab4d Mon Sep 17 00:00:00 2001
From: catfreed <catherine@kubos.co>
Date: Tue, 25 Oct 2016 16:11:22 -0500
Subject: [PATCH 22/37] Forcing bus width 4

---
 drivers/mmc/mmc.c | 4 ++--
 1 file changed, 2 insertions(+), 2 deletions(-)

diff --git a/drivers/mmc/mmc.c b/drivers/mmc/mmc.c
index d3f0555..673b020 100644
--- a/drivers/mmc/mmc.c
+++ b/drivers/mmc/mmc.c
@@ -1651,8 +1651,8 @@ int mmc_start_init(struct mmc *mmc)
 		return err;
 #endif
 	mmc->ddr_mode = 0;
-	mmc_set_bus_width(mmc, 1);
-	mmc_set_clock(mmc, 1);
+	mmc_set_bus_width(mmc, 4);
+	mmc_set_clock(mmc, 4);
 
 #ifdef CONFIG_AT91SAM9G20KUBOS
 	board_kubos_mmc_power_init(mmc);
-- 
2.7.4


From 636679e00a9d2cbd0382727c6832849fdeb5a6d3 Mon Sep 17 00:00:00 2001
From: catfreed <catherine@kubos.co>
Date: Wed, 26 Oct 2016 10:44:14 -0500
Subject: [PATCH 23/37] Turning on power pin (PB6) + code cleanup

---
 board/kubos/at91sam9g20kubos/at91sam9g20kubos.c | 3 +++
 drivers/mmc/mmc.c                               | 4 ++--
 include/configs/at91sam9g20kubos.h              | 2 --
 3 files changed, 5 insertions(+), 4 deletions(-)

diff --git a/board/kubos/at91sam9g20kubos/at91sam9g20kubos.c b/board/kubos/at91sam9g20kubos/at91sam9g20kubos.c
index 2491f5c..0179d03 100644
--- a/board/kubos/at91sam9g20kubos/at91sam9g20kubos.c
+++ b/board/kubos/at91sam9g20kubos/at91sam9g20kubos.c
@@ -116,6 +116,9 @@ int board_mmc_init(bd_t *bd)
 {
 	at91_mci_hw_init();
 
+	/* Turn on the SD power pin*/
+	at91_set_pio_output(AT91_PIO_PORTB, 6, 1);
+
 	return atmel_mci_init((void *)ATMEL_BASE_MCI);
 }
 #endif
diff --git a/drivers/mmc/mmc.c b/drivers/mmc/mmc.c
index 673b020..d3f0555 100644
--- a/drivers/mmc/mmc.c
+++ b/drivers/mmc/mmc.c
@@ -1651,8 +1651,8 @@ int mmc_start_init(struct mmc *mmc)
 		return err;
 #endif
 	mmc->ddr_mode = 0;
-	mmc_set_bus_width(mmc, 4);
-	mmc_set_clock(mmc, 4);
+	mmc_set_bus_width(mmc, 1);
+	mmc_set_clock(mmc, 1);
 
 #ifdef CONFIG_AT91SAM9G20KUBOS
 	board_kubos_mmc_power_init(mmc);
diff --git a/include/configs/at91sam9g20kubos.h b/include/configs/at91sam9g20kubos.h
index c5d9bff..b2e5198 100644
--- a/include/configs/at91sam9g20kubos.h
+++ b/include/configs/at91sam9g20kubos.h
@@ -148,8 +148,6 @@
 #define CONFIG_MMC_TRACE
 #define CONFIG_GENERIC_MMC
 #define CONFIG_GENERIC_ATMEL_MCI
-#define CONFIG_SYS_MMC_CD_PIN	AT91_PIN_PC9
-#define CONFIG_ATMEL_MCI_PORTB
 #endif
 
 /* FAT */
-- 
2.7.4


From ae02aa6833929c616bc9ef42d442142653816b3a Mon Sep 17 00:00:00 2001
From: catfreed <catherine@kubos.co>
Date: Wed, 26 Oct 2016 11:02:35 -0500
Subject: [PATCH 24/37] Trying pullup instead of output

---
 board/kubos/at91sam9g20kubos/at91sam9g20kubos.c | 4 +++-
 1 file changed, 3 insertions(+), 1 deletion(-)

diff --git a/board/kubos/at91sam9g20kubos/at91sam9g20kubos.c b/board/kubos/at91sam9g20kubos/at91sam9g20kubos.c
index 0179d03..9d20d91 100644
--- a/board/kubos/at91sam9g20kubos/at91sam9g20kubos.c
+++ b/board/kubos/at91sam9g20kubos/at91sam9g20kubos.c
@@ -116,8 +116,10 @@ int board_mmc_init(bd_t *bd)
 {
 	at91_mci_hw_init();
 
+	debug("board_mmc_init turn on power pin\r\n");
+
 	/* Turn on the SD power pin*/
-	at91_set_pio_output(AT91_PIO_PORTB, 6, 1);
+	at91_set_pio_pullup(AT91_PIO_PORTB, 6, 1);
 
 	return atmel_mci_init((void *)ATMEL_BASE_MCI);
 }
-- 
2.7.4


From 0ec6ed2f2f0fb3f45a2000a0e919adbb230807c9 Mon Sep 17 00:00:00 2001
From: catfreed <catherine@kubos.co>
Date: Wed, 26 Oct 2016 11:16:15 -0500
Subject: [PATCH 25/37] Trying A periph instead of pullup

---
 board/kubos/at91sam9g20kubos/at91sam9g20kubos.c | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/board/kubos/at91sam9g20kubos/at91sam9g20kubos.c b/board/kubos/at91sam9g20kubos/at91sam9g20kubos.c
index 9d20d91..0f97fe5 100644
--- a/board/kubos/at91sam9g20kubos/at91sam9g20kubos.c
+++ b/board/kubos/at91sam9g20kubos/at91sam9g20kubos.c
@@ -119,7 +119,7 @@ int board_mmc_init(bd_t *bd)
 	debug("board_mmc_init turn on power pin\r\n");
 
 	/* Turn on the SD power pin*/
-	at91_set_pio_pullup(AT91_PIO_PORTB, 6, 1);
+	at91_set_a_periph(AT91_PIO_PORTB, 6, 1);
 
 	return atmel_mci_init((void *)ATMEL_BASE_MCI);
 }
-- 
2.7.4


From b2fbb4e6bebd889e570b0001f17e8cc3a7c11e78 Mon Sep 17 00:00:00 2001
From: catfreed <catherine@kubos.co>
Date: Wed, 26 Oct 2016 14:53:30 -0500
Subject: [PATCH 26/37] Trying power init again

---
 board/kubos/at91sam9g20kubos/at91sam9g20kubos.c | 6 +++---
 drivers/mmc/gen_atmel_mci.c                     | 3 ++-
 2 files changed, 5 insertions(+), 4 deletions(-)

diff --git a/board/kubos/at91sam9g20kubos/at91sam9g20kubos.c b/board/kubos/at91sam9g20kubos/at91sam9g20kubos.c
index 0f97fe5..16b9720 100644
--- a/board/kubos/at91sam9g20kubos/at91sam9g20kubos.c
+++ b/board/kubos/at91sam9g20kubos/at91sam9g20kubos.c
@@ -119,7 +119,7 @@ int board_mmc_init(bd_t *bd)
 	debug("board_mmc_init turn on power pin\r\n");
 
 	/* Turn on the SD power pin*/
-	at91_set_a_periph(AT91_PIO_PORTB, 6, 1);
+	at91_set_pio_output(AT91_PIO_PORTB, 6, 1);
 
 	return atmel_mci_init((void *)ATMEL_BASE_MCI);
 }
@@ -179,7 +179,7 @@ int board_eth_init(bd_t *bis)
 
 void board_kubos_mmc_power_init(struct mmc *mmc)
 {
-/*	struct mmc_cmd cmd;
+	struct mmc_cmd cmd;
 	int err;
 	
 	debug("board_kubos_mmc_power_init start\r\n");
@@ -195,5 +195,5 @@ void board_kubos_mmc_power_init(struct mmc *mmc)
 	if (err)
 		debug("board_kubos_mmc_power_init err=%d\r\n", err);
 
-	udelay(2000);*/
+	udelay(2000);
 }
diff --git a/drivers/mmc/gen_atmel_mci.c b/drivers/mmc/gen_atmel_mci.c
index 63c161b..fe8542b 100644
--- a/drivers/mmc/gen_atmel_mci.c
+++ b/drivers/mmc/gen_atmel_mci.c
@@ -369,7 +369,8 @@ mci_send_sp_cmd(struct mmc *mmc, struct mmc_cmd *cmd, struct mmc_data *data)
 		writel(data->blocks | MMCI_BF(BLKLEN, mmc->read_bl_len),
 			&mci->blkr);
 
-	cmdr |= MMCI_BF(SPCMD, 1);
+	cmdr |= MMCI_BF(SPCMD, MMCI_SPCMD_INIT_CMD);
+	cmdr |= MMCI_BF(OPDCMD, 1);
 
 	/* Send the command */
 	writel(cmd->cmdarg, &mci->argr);
-- 
2.7.4


From 410a0d47f0ea93ae433412d2a9a54281562f3622 Mon Sep 17 00:00:00 2001
From: catfreed <catherine@kubos.co>
Date: Thu, 27 Oct 2016 10:22:55 -0500
Subject: [PATCH 27/37] Trying other SD port

---
 board/kubos/at91sam9g20kubos/at91sam9g20kubos.c | 8 ++++++--
 1 file changed, 6 insertions(+), 2 deletions(-)

diff --git a/board/kubos/at91sam9g20kubos/at91sam9g20kubos.c b/board/kubos/at91sam9g20kubos/at91sam9g20kubos.c
index 16b9720..a1307ce 100644
--- a/board/kubos/at91sam9g20kubos/at91sam9g20kubos.c
+++ b/board/kubos/at91sam9g20kubos/at91sam9g20kubos.c
@@ -118,8 +118,12 @@ int board_mmc_init(bd_t *bd)
 
 	debug("board_mmc_init turn on power pin\r\n");
 
-	/* Turn on the SD power pin*/
-	at91_set_pio_output(AT91_PIO_PORTB, 6, 1);
+	/* Turn on the SD0 power pin*/
+	//at91_set_pio_output(AT91_PIO_PORTB, 6, 1);
+
+	/* Turn on SD1 */
+	at91_set_pio_output(AT91_PIO_PORTB, 16, 1);
+	at91_set_pio_output(AT91_PIO_PORTB, 7, 1);
 
 	return atmel_mci_init((void *)ATMEL_BASE_MCI);
 }
-- 
2.7.4


From 6df8075b31609900530a6b9166462a3c68b48fc9 Mon Sep 17 00:00:00 2001
From: catfreed <catherine@kubos.co>
Date: Thu, 27 Oct 2016 10:34:56 -0500
Subject: [PATCH 28/37] Making sure the definition isn't backwards

---
 board/kubos/at91sam9g20kubos/at91sam9g20kubos.c | 4 ++--
 1 file changed, 2 insertions(+), 2 deletions(-)

diff --git a/board/kubos/at91sam9g20kubos/at91sam9g20kubos.c b/board/kubos/at91sam9g20kubos/at91sam9g20kubos.c
index a1307ce..3af3c6a 100644
--- a/board/kubos/at91sam9g20kubos/at91sam9g20kubos.c
+++ b/board/kubos/at91sam9g20kubos/at91sam9g20kubos.c
@@ -119,11 +119,11 @@ int board_mmc_init(bd_t *bd)
 	debug("board_mmc_init turn on power pin\r\n");
 
 	/* Turn on the SD0 power pin*/
-	//at91_set_pio_output(AT91_PIO_PORTB, 6, 1);
+	at91_set_pio_output(AT91_PIO_PORTB, 6, 1);
 
 	/* Turn on SD1 */
 	at91_set_pio_output(AT91_PIO_PORTB, 16, 1);
-	at91_set_pio_output(AT91_PIO_PORTB, 7, 1);
+	//at91_set_pio_output(AT91_PIO_PORTB, 7, 1);
 
 	return atmel_mci_init((void *)ATMEL_BASE_MCI);
 }
-- 
2.7.4


From 705a73857ac0d9add759199c50e4d0bd5411bd6b Mon Sep 17 00:00:00 2001
From: catfreed <catherine@kubos.co>
Date: Thu, 27 Oct 2016 11:17:11 -0500
Subject: [PATCH 29/37] Turning SDSEL back off

---
 board/kubos/at91sam9g20kubos/at91sam9g20kubos.c | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/board/kubos/at91sam9g20kubos/at91sam9g20kubos.c b/board/kubos/at91sam9g20kubos/at91sam9g20kubos.c
index 3af3c6a..ccf4ac0 100644
--- a/board/kubos/at91sam9g20kubos/at91sam9g20kubos.c
+++ b/board/kubos/at91sam9g20kubos/at91sam9g20kubos.c
@@ -122,7 +122,7 @@ int board_mmc_init(bd_t *bd)
 	at91_set_pio_output(AT91_PIO_PORTB, 6, 1);
 
 	/* Turn on SD1 */
-	at91_set_pio_output(AT91_PIO_PORTB, 16, 1);
+	//at91_set_pio_output(AT91_PIO_PORTB, 16, 1);
 	//at91_set_pio_output(AT91_PIO_PORTB, 7, 1);
 
 	return atmel_mci_init((void *)ATMEL_BASE_MCI);
-- 
2.7.4


From 93943dab95b6b0109db5f5ef9c8221035ad4df46 Mon Sep 17 00:00:00 2001
From: catfreed <catherine@kubos.co>
Date: Thu, 27 Oct 2016 13:36:24 -0500
Subject: [PATCH 30/37] Adding data timeout

---
 drivers/mmc/gen_atmel_mci.c | 56 +++++++++++++++++++++++++++++++++++++++++++++
 1 file changed, 56 insertions(+)

diff --git a/drivers/mmc/gen_atmel_mci.c b/drivers/mmc/gen_atmel_mci.c
index fe8542b..ab51a13 100644
--- a/drivers/mmc/gen_atmel_mci.c
+++ b/drivers/mmc/gen_atmel_mci.c
@@ -57,6 +57,59 @@ static void dump_cmd(u32 cmdr, u32 arg, u32 status, const char* msg)
 	      cmdr, cmdr & 0x3F, arg, status, msg);
 }
 
+static void mci_set_data_timeout(struct mmc *mmc)
+{
+	atmel_mci_t *mci = (atmel_mci_t *)mmc->priv;
+
+	static const unsigned int dtomul_to_shift[] = {
+		0, 4, 7, 8, 10, 12, 16, 20,
+	};
+
+	unsigned int timeout_ns, timeout_clks;
+	unsigned int dtocyc, dtomul;
+	unsigned int shift;
+	u32 dtor;
+
+	/* we assume 1.5 ms data-read-access-time-1 (taac -> see CSD spec)
+	 * and 0 clock data-read-access-time-2 (nsac -> see CSD spec)
+	 */
+	//timeout_ns = 1500000;
+	timeout_ns = 5000000;
+	timeout_clks = 0;
+
+	debug("gen_atmel_mci: timeout_ns = %u\n", timeout_ns);
+
+	timeout_clks += (((timeout_ns + 9) / 10)
+			 * ((mmc->clock + 99999) / 100000) + 9999) / 10000;
+	if (!IS_SD(mmc))
+		timeout_clks *= 10;
+	else
+		timeout_clks *= 100;
+	debug("gen_atmel_mci: timeout_clks = %u\n", timeout_clks);
+
+	dtocyc = timeout_clks;
+	dtomul = 0;
+	shift = 0;
+	while (dtocyc > 15 && dtomul < 8) {
+		dtomul++;
+		shift = dtomul_to_shift[dtomul];
+		dtocyc = (timeout_clks + (1 << shift) - 1) >> shift;
+	}
+
+	if (dtomul >= 8) {
+		dtomul = 7;
+		dtocyc = 15;
+		puts("Warning: Using maximum data timeout\n");
+	}
+
+	dtor = (MMCI_BF(DTOMUL, dtomul)
+		| MMCI_BF(DTOCYC, dtocyc));
+	writel(dtor, &mci->dtor);
+
+	debug("mci: Using %u cycles data timeout (DTOR=0x%x)\n",
+	       dtocyc << shift, dtor);
+}
+
 /* Setup for MCI Clock and Block Size */
 static void mci_set_mode(struct mmc *mmc, u32 hz, u32 blklen)
 {
@@ -70,6 +123,9 @@ static void mci_set_mode(struct mmc *mmc, u32 hz, u32 blklen)
 
 	debug("mci: bus_hz is %u, setting clock %u Hz, block size %u\n",
 		bus_hz, hz, blklen);
+
+	mci_set_data_timeout(mmc);
+
 	if (hz > 0) {
 		if (version >= 0x500) {
 			clkdiv = DIV_ROUND_UP(bus_hz, hz) - 2;
-- 
2.7.4


From 9df9d17122dfe10182ca68a97f1826d584ffc8b9 Mon Sep 17 00:00:00 2001
From: catfreed <catherine@kubos.co>
Date: Thu, 27 Oct 2016 14:50:13 -0500
Subject: [PATCH 31/37] Correctly turning on power pin (by pulling LOW...).
 Turned off debug.

---
 board/kubos/at91sam9g20kubos/at91sam9g20kubos.c | 8 ++++----
 cmd/gpio.c                                      | 2 +-
 include/common.h                                | 2 +-
 3 files changed, 6 insertions(+), 6 deletions(-)

diff --git a/board/kubos/at91sam9g20kubos/at91sam9g20kubos.c b/board/kubos/at91sam9g20kubos/at91sam9g20kubos.c
index ccf4ac0..03dcdb4 100644
--- a/board/kubos/at91sam9g20kubos/at91sam9g20kubos.c
+++ b/board/kubos/at91sam9g20kubos/at91sam9g20kubos.c
@@ -118,12 +118,12 @@ int board_mmc_init(bd_t *bd)
 
 	debug("board_mmc_init turn on power pin\r\n");
 
-	/* Turn on the SD0 power pin*/
-	at91_set_pio_output(AT91_PIO_PORTB, 6, 1);
+	/* Turn on the SD0 power pin - value must be LOW */
+	at91_set_pio_output(AT91_PIO_PORTB, 6, 0);
 
 	/* Turn on SD1 */
-	//at91_set_pio_output(AT91_PIO_PORTB, 16, 1);
-	//at91_set_pio_output(AT91_PIO_PORTB, 7, 1);
+	//at91_set_pio_output(AT91_PIO_PORTB, 16, 0);
+	//at91_set_pio_output(AT91_PIO_PORTB, 7, 0);
 
 	return atmel_mci_init((void *)ATMEL_BASE_MCI);
 }
diff --git a/cmd/gpio.c b/cmd/gpio.c
index ecdc453..9497d2c 100644
--- a/cmd/gpio.c
+++ b/cmd/gpio.c
@@ -230,7 +230,7 @@ static int do_gpio(cmd_tbl_t *cmdtp, int flag, int argc, char * const argv[])
 	if (ret != -EBUSY)
 		gpio_free(gpio);
 
-	return value;
+	return ret;
 }
 
 U_BOOT_CMD(gpio, 4, 0, do_gpio,
diff --git a/include/common.h b/include/common.h
index dd65eca..39739ce 100644
--- a/include/common.h
+++ b/include/common.h
@@ -95,7 +95,7 @@ typedef volatile unsigned char	vu_char;
 #define CONFIG_SYS_SUPPORT_64BIT_DATA
 #endif
 
-#define DEBUG 1
+/*#define DEBUG 1*/
 
 #ifdef DEBUG
 #define _DEBUG	1
-- 
2.7.4


From 5220ac09adbfa578df1916854f6b29863525d3ee Mon Sep 17 00:00:00 2001
From: catfreed <catherine@kubos.co>
Date: Thu, 27 Oct 2016 16:12:31 -0500
Subject: [PATCH 32/37] Fixing bootcmd, turning off extra data timeout

---
 drivers/mmc/gen_atmel_mci.c        | 2 +-
 include/configs/at91sam9g20kubos.h | 6 +++---
 2 files changed, 4 insertions(+), 4 deletions(-)

diff --git a/drivers/mmc/gen_atmel_mci.c b/drivers/mmc/gen_atmel_mci.c
index ab51a13..ebface6 100644
--- a/drivers/mmc/gen_atmel_mci.c
+++ b/drivers/mmc/gen_atmel_mci.c
@@ -124,7 +124,7 @@ static void mci_set_mode(struct mmc *mmc, u32 hz, u32 blklen)
 	debug("mci: bus_hz is %u, setting clock %u Hz, block size %u\n",
 		bus_hz, hz, blklen);
 
-	mci_set_data_timeout(mmc);
+	//mci_set_data_timeout(mmc);
 
 	if (hz > 0) {
 		if (version >= 0x500) {
diff --git a/include/configs/at91sam9g20kubos.h b/include/configs/at91sam9g20kubos.h
index b2e5198..5ed3ab9 100644
--- a/include/configs/at91sam9g20kubos.h
+++ b/include/configs/at91sam9g20kubos.h
@@ -206,13 +206,13 @@
 #define CONFIG_ENV_SIZE		0x20000		/* 1 sector = 128 kB */
 /* Copy .dtb file and kernel into SDRAM, then boot them */
 #define CONFIG_BOOTCOMMAND	"cp.b 0x00070000 0x21800000 0x5000; " \
-				"fatload mmc 0:1 0x21880000 zImage; " \
-				"bootm 0x21880000 - 0x21800000"
+				"fatload mmc 0:2 0x21880000 zImage; " \
+				"bootz 0x21880000 - 0x21800000"
 #define CONFIG_BOOTARGS							\
 	"console=ttyS0,2000000 earlyprintk "				\
 	"root=/dev/mtdblock0 " \
 	"mtdparts=atmel_nand:-(root) "\
-	"root=/dev/mmcblk0p2 rw rootfstype=ext4 rootwait"
+	"root=/dev/mmcblk0p3 rw rootfstype=ext4 rootwait"
 
 #define CONFIG_SYS_FLASH_CFI			1
 #define CONFIG_FLASH_CFI_DRIVER			1
-- 
2.7.4


From 8136f071c50ef5a207935292eea1f56308bbfefc Mon Sep 17 00:00:00 2001
From: catfreed <catherine@kubos.co>
Date: Fri, 28 Oct 2016 16:33:40 -0500
Subject: [PATCH 33/37] Turning debug back on.  Turning off sd command trace

---
 include/common.h                   | 2 +-
 include/configs/at91sam9g20kubos.h | 2 +-
 2 files changed, 2 insertions(+), 2 deletions(-)

diff --git a/include/common.h b/include/common.h
index 39739ce..dd65eca 100644
--- a/include/common.h
+++ b/include/common.h
@@ -95,7 +95,7 @@ typedef volatile unsigned char	vu_char;
 #define CONFIG_SYS_SUPPORT_64BIT_DATA
 #endif
 
-/*#define DEBUG 1*/
+#define DEBUG 1
 
 #ifdef DEBUG
 #define _DEBUG	1
diff --git a/include/configs/at91sam9g20kubos.h b/include/configs/at91sam9g20kubos.h
index 5ed3ab9..a1a1712 100644
--- a/include/configs/at91sam9g20kubos.h
+++ b/include/configs/at91sam9g20kubos.h
@@ -145,7 +145,7 @@
 /* MMC - Turned on in defconfig file*/
 #ifdef CONFIG_CMD_MMC
 #define CONFIG_MMC
-#define CONFIG_MMC_TRACE
+/*#define CONFIG_MMC_TRACE*/
 #define CONFIG_GENERIC_MMC
 #define CONFIG_GENERIC_ATMEL_MCI
 #endif
-- 
2.7.4


From 3a8f1e9f2945b1b3e3b5106a828137ddbba702cb Mon Sep 17 00:00:00 2001
From: catfreed <catherine@kubos.co>
Date: Mon, 31 Oct 2016 09:43:11 -0500
Subject: [PATCH 34/37] Adding dbt debugging

---
 common/image.c | 16 ++++++++++++++--
 1 file changed, 14 insertions(+), 2 deletions(-)

diff --git a/common/image.c b/common/image.c
index a5d19ab..4c9cf4d 100644
--- a/common/image.c
+++ b/common/image.c
@@ -859,22 +859,34 @@ ulong genimg_get_kernel_addr(char * const img_addr)
  */
 int genimg_get_format(const void *img_addr)
 {
+	int rc = 0;
+
 #if defined(CONFIG_IMAGE_FORMAT_LEGACY)
 	const image_header_t *hdr;
 
 	hdr = (const image_header_t *)img_addr;
-	if (image_check_magic(hdr))
+	if ((rc = image_check_magic(hdr)))
+	{
 		return IMAGE_FORMAT_LEGACY;
+	}
+	debug("image_check_magic: %d\r\n", rc);
 #endif
 #if IMAGE_ENABLE_FIT || IMAGE_ENABLE_OF_LIBFDT
-	if (fdt_check_header(img_addr) == 0)
+	if ((rc = fdt_check_header(img_addr)) == 0)
+	{
 		return IMAGE_FORMAT_FIT;
+	}
+	debug("fdt_check_header: %d\r\n", rc);
 #endif
 #ifdef CONFIG_ANDROID_BOOT_IMAGE
 	if (android_image_check_header(img_addr) == 0)
 		return IMAGE_FORMAT_ANDROID;
 #endif
 
+#if !defined(CONFIG_IMAGE_FORMAT_LEGACY) && !IMAGE_ENABLE_FIT && !IMAGE_ENABLE_OF_LIBFDT
+	debug("NOTHING IS DEFINED...\r\n");
+#endif
+
 	return IMAGE_FORMAT_INVALID;
 }
 
-- 
2.7.4


From 7baf40b7050ac9b9cd7b8ed62148d66578ae9c31 Mon Sep 17 00:00:00 2001
From: catfreed <catherine@kubos.co>
Date: Mon, 31 Oct 2016 10:48:25 -0500
Subject: [PATCH 35/37] Fixing NOR flash address

---
 include/configs/at91sam9g20kubos.h | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/include/configs/at91sam9g20kubos.h b/include/configs/at91sam9g20kubos.h
index a1a1712..ab8f5c9 100644
--- a/include/configs/at91sam9g20kubos.h
+++ b/include/configs/at91sam9g20kubos.h
@@ -216,7 +216,7 @@
 
 #define CONFIG_SYS_FLASH_CFI			1
 #define CONFIG_FLASH_CFI_DRIVER			1
-#define PHYS_FLASH_1				0x00100000
+#define PHYS_FLASH_1				0x10000000
 #define CONFIG_SYS_FLASH_BASE			PHYS_FLASH_1
 #define CONFIG_SYS_MAX_FLASH_SECT		8
 #define CONFIG_SYS_MAX_FLASH_BANKS		1
-- 
2.7.4


From 063568badae43e11b95aed607425c3e39d61a02f Mon Sep 17 00:00:00 2001
From: catfreed <catherine@kubos.co>
Date: Fri, 4 Nov 2016 10:20:41 -0500
Subject: [PATCH 36/37] Updating bootargs and baudrate

---
 include/configs/at91sam9g20kubos.h | 12 ++++++------
 1 file changed, 6 insertions(+), 6 deletions(-)

diff --git a/include/configs/at91sam9g20kubos.h b/include/configs/at91sam9g20kubos.h
index ab8f5c9..c4d68a0 100644
--- a/include/configs/at91sam9g20kubos.h
+++ b/include/configs/at91sam9g20kubos.h
@@ -57,7 +57,7 @@
 #define CONFIG_ATMEL_USART
 #define CONFIG_USART_BASE		ATMEL_BASE_DBGU
 #define	CONFIG_USART_ID			ATMEL_ID_SYS
-#define CONFIG_BAUDRATE			2000000
+#define CONFIG_BAUDRATE			115200
 
 /* LED */
 /*TODO*/
@@ -202,14 +202,14 @@
 /* (bootstrap + u-boot + env +dtb in flash) + (linux in mmc) */
 /* TODO: This configuration could use some work...*/
 #define CONFIG_ENV_IS_IN_FLASH	1
-#define CONFIG_ENV_OFFSET		0x50000
-#define CONFIG_ENV_SIZE		0x20000		/* 1 sector = 128 kB */
+#define CONFIG_ENV_OFFSET		0x60000
+#define CONFIG_ENV_SIZE		0x2000		/* 1 sector = 128 kB */
 /* Copy .dtb file and kernel into SDRAM, then boot them */
-#define CONFIG_BOOTCOMMAND	"cp.b 0x00070000 0x21800000 0x5000; " \
+#define CONFIG_BOOTCOMMAND	"cp.b 0x10080000 0x21800000 0x5000; " \
 				"fatload mmc 0:2 0x21880000 zImage; " \
 				"bootz 0x21880000 - 0x21800000"
 #define CONFIG_BOOTARGS							\
-	"console=ttyS0,2000000 earlyprintk "				\
+	"console=ttyS0,115200 earlyprintk "				\
 	"root=/dev/mtdblock0 " \
 	"mtdparts=atmel_nand:-(root) "\
 	"root=/dev/mmcblk0p3 rw rootfstype=ext4 rootwait"
@@ -218,7 +218,7 @@
 #define CONFIG_FLASH_CFI_DRIVER			1
 #define PHYS_FLASH_1				0x10000000
 #define CONFIG_SYS_FLASH_BASE			PHYS_FLASH_1
-#define CONFIG_SYS_MAX_FLASH_SECT		8
+#define CONFIG_SYS_MAX_FLASH_SECT		22
 #define CONFIG_SYS_MAX_FLASH_BANKS		1
 
 /*
-- 
2.7.4


From 064e5947fd8ed6be51e507a6518afbcca651ce4e Mon Sep 17 00:00:00 2001
From: catfreed <catherine@kubos.co>
Date: Fri, 4 Nov 2016 12:57:28 -0500
Subject: [PATCH 37/37] Turning off extra debugging messages

---
 include/common.h | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/include/common.h b/include/common.h
index dd65eca..39739ce 100644
--- a/include/common.h
+++ b/include/common.h
@@ -95,7 +95,7 @@ typedef volatile unsigned char	vu_char;
 #define CONFIG_SYS_SUPPORT_64BIT_DATA
 #endif
 
-#define DEBUG 1
+/*#define DEBUG 1*/
 
 #ifdef DEBUG
 #define _DEBUG	1
-- 
2.7.4

